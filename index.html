<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="MH Manuel Haqiqatkhah">

<title>Daily dynamics and weekly rhythms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="index_files/libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Daily dynamics and weekly rhythms</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Supplemental Materials</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>MH Manuel Haqiqatkhah </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>
<nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-intro" id="toc-sec-intro"><span class="toc-section-number">0</span>  Introduction</a></li>
  <li><a href="#sec-foundations" id="toc-sec-foundations"><span class="toc-section-number">1</span>  Foundations</a>
  <ul>
  <li><a href="#sec-visualization" id="toc-sec-visualization"><span class="toc-section-number">1.1</span>  Time series visualizations</a></li>
  <li><a href="#sec-simulation" id="toc-sec-simulation"><span class="toc-section-number">1.2</span>  Simulating time series</a></li>
  <li><a href="#sec-sim-shiny" id="toc-sec-sim-shiny"><span class="toc-section-number">1.3</span>  Shiny app</a></li>
  </ul></li>
  <li><a href="#sec-modeling" id="toc-sec-modeling"><span class="toc-section-number">2</span>  Modeling time series data</a>
  <ul>
  <li><a href="#sec-fitting" id="toc-sec-fitting"><span class="toc-section-number">2.1</span>  Fitting time series models</a></li>
  <li><a href="#sec-estimates" id="toc-sec-estimates"><span class="toc-section-number">2.2</span>  Extracting parameter estimates</a></li>
  </ul></li>
  <li><a href="#sec-analysis" id="toc-sec-analysis"><span class="toc-section-number">3</span>  Analyzing empirical data</a>
  <ul>
  <li><a href="#sec-empirical-fitting" id="toc-sec-empirical-fitting"><span class="toc-section-number">3.1</span>  Fitting models to the whole dataset</a></li>
  <li><a href="#sec-empirical-results" id="toc-sec-empirical-results"><span class="toc-section-number">3.2</span>  Results</a></li>
  </ul></li>
  </ul>
</nav>
<section id="sec-intro" class="level1" data-number="0">
<h1 data-number="0"><span class="header-section-number">0</span> Introduction</h1>
<p>This document contains reproducible code of the manuscript on weekly patterns and dynamics. Please cite as</p>
<blockquote class="blockquote">
<p>citation info</p>
</blockquote>
<p>This document has two main sections:</p>
<p>In <a href="#sec-foundations">Section&nbsp;1</a> (corresponding to Sections 1 and 2 of the paper), we show functions used for making the visualizations (<a href="#sec-visualization">Section&nbsp;1.1</a>) and generating simulated data the data (<a href="#sec-simulation">Section&nbsp;1.2</a>), and we provide the Shiny app accompanying the paper (<a href="#sec-sim-shiny">Section&nbsp;1.3</a>).</p>
<p>In <a href="#sec-analysis">Section&nbsp;3</a> (corresponding to Sections 3 and 4 of the paper) we provide the code for analyzing individual time series according to different models within a single function (<a href="#sec-modeling">Section&nbsp;2</a>), and show the code used to run the study on the empirical data (<a href="#sec-fitting">Section&nbsp;2.1</a>), and the code used to report the results (<strong>?@sec-results</strong>).</p>
<p>Thanks to Dr.&nbsp;Aidan Wrightâ€™s permission, we are sharing the data used in our study, that is, the average PA scores of 98 individuals (that had less than 50% missingness) from the dataset collected by <span class="citation" data-cites="wright_2015_DailyInterpersonalAffective">@wright_2015_DailyInterpersonalAffective</span> in the <code>data</code> folder. The shared dataset does not contain demographic information, and the unique person identifies have been shuffled and stored as <code>id</code>. Other variables in the dataset are the measurement date (<code>date</code>), the measurement time (<code>t</code>, starting from the first day of the study on 2013-02-11), the average PA time series (<code>y</code>), the weekday associated with the measurement date (<code>weekday</code>), and the weekday number (<code>weekday_num</code>) with Monday being the first day of the week.</p>
<p>but without the demographic information or other variables including dates empirical data used in the study, we store the individual model fits in the <code>fits</code> folder within this repository, and their aggregated summaries in the <code>summaries</code> folder.</p>
<p>To replicate the study from the scratch, you should first either clone the repository (using <code>git clone https://github.com/psyguy/WeCycle.git</code>) or <a href="https://github.com/psyguy/WeCycle/archive/refs/heads/main.zip">download the repository as a zip file</a> and extract it on your machine. Then you can sequentially run the <code>.R</code> files you find in the <code>scripts</code> folder. Instead of running the scripts separately, if you have <a href="https://quarto.org/docs/get-started/">Quarto installed</a>, you can also compile <code>index.qmd</code> located in the root directory using Quarto .</p>
</section>
<section id="sec-foundations" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Foundations</h1>
<p>The code used for plotting the time series and fitting the models requires the time series <span class="math inline">\(y_t\)</span> to be stored in a data.frame (which, let us call <code>df</code>) with at least three columns:</p>
<ul>
<li><p><code>t</code>: Indicating the time of the measurement</p></li>
<li><p><code>y</code>: The value <span class="math inline">\(y_t\)</span> on time <span class="math inline">\(t\)</span></p></li>
<li><p><code>weekday</code> (or <code>weekday_num</code>): The name (or number) of the weekday corresponding to <code>t</code>. In the case of the former, it should be in the form of capitalized three letter codes (<code>"Mon"</code>, <code>"Tue"</code>, â€¦, <code>"Sun"</code>). Note that we consider Monday to be the first day of the week, and Sunday be the 0th/7th day of the week.</p></li>
</ul>
<p>The column <code>weekday</code> (and <code>weekday_num</code>) can be generated if the date (e.g., as <code>date</code>) is included in <code>df</code>, using <code>lubridate::wday</code> and setting:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_3cda31ae8eaeb70190e99fad178fb1c1">
<details open="">
<summary>Click to expand the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="fu">mutate</span>(<span class="at">weekday =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb1-3"><a href="#cb1-3"></a>                                   <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb1-4"><a href="#cb1-4"></a>                                   <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1-5"><a href="#cb1-5"></a>         <span class="at">weekday_num =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb1-6"><a href="#cb1-6"></a>                                       <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb1-7"><a href="#cb1-7"></a>                                       <span class="at">label =</span> <span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The missing values in the time series should be explicitly indicated with <code>NA</code> in the dataframeâ€”that is, we should have a row for each time pointâ€”which can be achieved by:</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_248bdfe67fa481862df50cdefbb09077">
<details open="">
<summary>Click to expand the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="fu">right_join</span>(<span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">min</span>(df<span class="sc">$</span>t)<span class="sc">:</span><span class="fu">max</span>(df<span class="sc">$</span>t)),</span>
<span id="cb2-3"><a href="#cb2-3"></a>             <span class="at">by =</span> <span class="st">"t"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="fu">arrange</span>(t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="sec-visualization" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="sec-visualization"><span class="header-section-number">1.1</span> Time series visualizations</h2>
<p>The visualizations shown in discussed in the paper were plotted using separate functions for each plot, that are named accordingly <code>plot_hist()</code> , <code>plot_seq()</code>, <code>plot_dowe()</code>, <code>plot_psd()</code>, <code>plot_acf()</code>, and <code>plot_pacf()</code>. The main argument of these functions is <code>d</code>, which can be a numerical vector (for which the weekdays are added, starting by Monday), or it can be a dataframe with the columns specifiedexplained earlier.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-5_fe3e5ea2ec62856dbfb00327a4f8b28c">
<details>
<summary>Click to reveal <code>plot_hist()</code></summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>plot_hist <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-2"><a href="#cb3-2"></a>                      <span class="at">title =</span> <span class="st">" "</span>,</span>
<span id="cb3-3"><a href="#cb3-3"></a>                      <span class="at">subtitle =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-4"><a href="#cb3-4"></a>                      <span class="at">remove_titles =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-5"><a href="#cb3-5"></a>                      <span class="at">remove_xlab =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-6"><a href="#cb3-6"></a>                      <span class="at">scale_rel =</span> <span class="fl">0.9</span>,</span>
<span id="cb3-7"><a href="#cb3-7"></a>                      <span class="at">max_acf.lag =</span> <span class="dv">35</span>,</span>
<span id="cb3-8"><a href="#cb3-8"></a>                      <span class="at">max_period =</span> <span class="dv">15</span>,</span>
<span id="cb3-9"><a href="#cb3-9"></a>                      <span class="at">ymin =</span> <span class="dv">0</span><span class="fl">-0.1</span>,</span>
<span id="cb3-10"><a href="#cb3-10"></a>                      <span class="at">ymax =</span> <span class="dv">4</span><span class="fl">+0.1</span>,</span>
<span id="cb3-11"><a href="#cb3-11"></a>                      <span class="at">max_t =</span> <span class="dv">140</span>,</span>
<span id="cb3-12"><a href="#cb3-12"></a>                      <span class="at">max_weeks =</span> <span class="dv">25</span>,</span>
<span id="cb3-13"><a href="#cb3-13"></a>                      <span class="at">col_weekly =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb3-14"><a href="#cb3-14"></a>                      <span class="at">col_dowe.line =</span> <span class="st">"mediumorchid4"</span>,</span>
<span id="cb3-15"><a href="#cb3-15"></a>                      <span class="at">col_dowe.point =</span> <span class="st">"deeppink1"</span>,</span>
<span id="cb3-16"><a href="#cb3-16"></a>                      <span class="at">col_ts =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb3-17"><a href="#cb3-17"></a>                      <span class="at">col_ts.point =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb3-18"><a href="#cb3-18"></a>                      <span class="at">col_hist =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb3-19"><a href="#cb3-19"></a>                      <span class="at">col_acf =</span> <span class="st">"darkolivegreen3"</span>,</span>
<span id="cb3-20"><a href="#cb3-20"></a>                      <span class="at">col_pacf =</span> <span class="st">"darkorange3"</span>,</span>
<span id="cb3-21"><a href="#cb3-21"></a>                      <span class="at">col_spec =</span> <span class="st">"darkorchid4"</span>,</span>
<span id="cb3-22"><a href="#cb3-22"></a>                      <span class="at">col_hlines =</span> <span class="st">"dimgray"</span>) {</span>
<span id="cb3-23"><a href="#cb3-23"></a></span>
<span id="cb3-24"><a href="#cb3-24"></a>  <span class="co"># Transforming the input to an appropriate dataframe</span></span>
<span id="cb3-25"><a href="#cb3-25"></a>  d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">data_shaper</span>()</span>
<span id="cb3-26"><a href="#cb3-26"></a></span>
<span id="cb3-27"><a href="#cb3-27"></a>  <span class="co"># Making sure the optimal theme is in place</span></span>
<span id="cb3-28"><a href="#cb3-28"></a>  <span class="fu">theme_set</span>(ggthemes<span class="sc">::</span><span class="fu">theme_few</span>())</span>
<span id="cb3-29"><a href="#cb3-29"></a></span>
<span id="cb3-30"><a href="#cb3-30"></a>  breaks_y <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">floor</span>(ymin),</span>
<span id="cb3-31"><a href="#cb3-31"></a>                  <span class="fu">ceiling</span>(ymax))</span>
<span id="cb3-32"><a href="#cb3-32"></a>  <span class="co"># Making sure the limits are not off</span></span>
<span id="cb3-33"><a href="#cb3-33"></a>  ymin <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">min</span>(d<span class="sc">$</span>y), ymin)</span>
<span id="cb3-34"><a href="#cb3-34"></a>  ymax <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">max</span>(d<span class="sc">$</span>y), ymax)</span>
<span id="cb3-35"><a href="#cb3-35"></a></span>
<span id="cb3-36"><a href="#cb3-36"></a>  p_out <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb3-37"><a href="#cb3-37"></a>    <span class="fu">mutate</span>(<span class="at">group_mean =</span> <span class="fu">mean</span>(y,</span>
<span id="cb3-38"><a href="#cb3-38"></a>                             <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>    <span class="fu">group_by</span>(weekday,</span>
<span id="cb3-40"><a href="#cb3-40"></a>             <span class="at">.add =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>    <span class="fu">mutate</span>(<span class="at">weekday_mean =</span> <span class="fu">mean</span>(y,</span>
<span id="cb3-42"><a href="#cb3-42"></a>                               <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-44"><a href="#cb3-44"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>    <span class="fu">aes</span>(<span class="at">x =</span> y) <span class="sc">+</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>    <span class="fu">geom_histogram</span>(</span>
<span id="cb3-47"><a href="#cb3-47"></a>      <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(ndensity)),</span>
<span id="cb3-48"><a href="#cb3-48"></a>      <span class="at">center =</span> <span class="dv">0</span>,</span>
<span id="cb3-49"><a href="#cb3-49"></a>      <span class="at">bins =</span> <span class="dv">40</span>,</span>
<span id="cb3-50"><a href="#cb3-50"></a>      <span class="at">fill =</span> col_hist</span>
<span id="cb3-51"><a href="#cb3-51"></a>    ) <span class="sc">+</span></span>
<span id="cb3-52"><a href="#cb3-52"></a>    <span class="fu">geom_vline</span>(</span>
<span id="cb3-53"><a href="#cb3-53"></a>      <span class="fu">aes</span>(<span class="at">xintercept =</span> group_mean),</span>
<span id="cb3-54"><a href="#cb3-54"></a>      <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb3-55"><a href="#cb3-55"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.2</span>)</span>
<span id="cb3-56"><a href="#cb3-56"></a>    ) <span class="sc">+</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Distribution"</span>,</span>
<span id="cb3-58"><a href="#cb3-58"></a>         <span class="at">x =</span> <span class="st">"y"</span>,</span>
<span id="cb3-59"><a href="#cb3-59"></a>         <span class="at">y =</span> title) <span class="sc">+</span></span>
<span id="cb3-60"><a href="#cb3-60"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> breaks_y) <span class="sc">+</span></span>
<span id="cb3-61"><a href="#cb3-61"></a>    <span class="fu">xlim</span>(ymin, ymax) <span class="sc">+</span></span>
<span id="cb3-62"><a href="#cb3-62"></a>    <span class="fu">theme</span>(</span>
<span id="cb3-63"><a href="#cb3-63"></a>      <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb3-64"><a href="#cb3-64"></a>      <span class="co"># axis.title.y = element_blank(),</span></span>
<span id="cb3-65"><a href="#cb3-65"></a>      <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb3-66"><a href="#cb3-66"></a>      <span class="at">axis.line.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb3-67"><a href="#cb3-67"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.4</span><span class="sc">*</span>scale_rel)),</span>
<span id="cb3-68"><a href="#cb3-68"></a>      <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb3-69"><a href="#cb3-69"></a>    )</span>
<span id="cb3-70"><a href="#cb3-70"></a></span>
<span id="cb3-71"><a href="#cb3-71"></a>  <span class="cf">if</span> (remove_titles)</span>
<span id="cb3-72"><a href="#cb3-72"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_blank</span>())</span>
<span id="cb3-73"><a href="#cb3-73"></a>  <span class="cf">if</span> (remove_xlab)</span>
<span id="cb3-74"><a href="#cb3-74"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>)</span>
<span id="cb3-75"><a href="#cb3-75"></a></span>
<span id="cb3-76"><a href="#cb3-76"></a>  p_out</span>
<span id="cb3-77"><a href="#cb3-77"></a></span>
<span id="cb3-78"><a href="#cb3-78"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-6_4607ae257e704b319f92b1f12af9ab75">
<details>
<summary>Click to reveal <code>plot_seq()</code></summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>plot_seq <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-2"><a href="#cb4-2"></a>                     <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-3"><a href="#cb4-3"></a>                     <span class="at">subtitle =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-4"><a href="#cb4-4"></a>                     <span class="at">remove_titles =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-5"><a href="#cb4-5"></a>                     <span class="at">remove_xlab =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-6"><a href="#cb4-6"></a>                     <span class="at">scale_rel =</span> <span class="fl">0.9</span>,</span>
<span id="cb4-7"><a href="#cb4-7"></a>                     <span class="at">max_acf.lag =</span> <span class="dv">35</span>,</span>
<span id="cb4-8"><a href="#cb4-8"></a>                     <span class="at">max_period =</span> <span class="dv">15</span>,</span>
<span id="cb4-9"><a href="#cb4-9"></a>                     <span class="at">ymin =</span> <span class="dv">0</span><span class="fl">-0.1</span>,</span>
<span id="cb4-10"><a href="#cb4-10"></a>                     <span class="at">ymax =</span> <span class="dv">4</span><span class="fl">+0.1</span>,</span>
<span id="cb4-11"><a href="#cb4-11"></a>                     <span class="at">max_t =</span> <span class="dv">140</span>,</span>
<span id="cb4-12"><a href="#cb4-12"></a>                     <span class="at">max_weeks =</span> <span class="dv">25</span>,</span>
<span id="cb4-13"><a href="#cb4-13"></a>                     <span class="at">col_weekly =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb4-14"><a href="#cb4-14"></a>                     <span class="at">col_dowe.line =</span> <span class="st">"mediumorchid4"</span>,</span>
<span id="cb4-15"><a href="#cb4-15"></a>                     <span class="at">col_dowe.point =</span> <span class="st">"deeppink1"</span>,</span>
<span id="cb4-16"><a href="#cb4-16"></a>                     <span class="at">col_ts =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb4-17"><a href="#cb4-17"></a>                     <span class="at">col_ts.point =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb4-18"><a href="#cb4-18"></a>                     <span class="at">col_hist =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb4-19"><a href="#cb4-19"></a>                     <span class="at">col_acf =</span> <span class="st">"darkolivegreen3"</span>,</span>
<span id="cb4-20"><a href="#cb4-20"></a>                     <span class="at">col_pacf =</span> <span class="st">"darkorange3"</span>,</span>
<span id="cb4-21"><a href="#cb4-21"></a>                     <span class="at">col_spec =</span> <span class="st">"darkorchid4"</span>,</span>
<span id="cb4-22"><a href="#cb4-22"></a>                     <span class="at">col_hlines =</span> <span class="st">"dimgray"</span>) {</span>
<span id="cb4-23"><a href="#cb4-23"></a></span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a>  <span class="co"># Transforming the input to an appropriate dataframe</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>  d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">data_shaper</span>()</span>
<span id="cb4-27"><a href="#cb4-27"></a></span>
<span id="cb4-28"><a href="#cb4-28"></a>  <span class="co"># Making sure the optimal theme is in place</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>  <span class="fu">theme_set</span>(ggthemes<span class="sc">::</span><span class="fu">theme_few</span>())</span>
<span id="cb4-30"><a href="#cb4-30"></a></span>
<span id="cb4-31"><a href="#cb4-31"></a>  <span class="co"># Making sure the limits are not off</span></span>
<span id="cb4-32"><a href="#cb4-32"></a>  ymin <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">min</span>(d<span class="sc">$</span>y), ymin)</span>
<span id="cb4-33"><a href="#cb4-33"></a>  ymax <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">max</span>(d<span class="sc">$</span>y), ymax)</span>
<span id="cb4-34"><a href="#cb4-34"></a></span>
<span id="cb4-35"><a href="#cb4-35"></a>  p_out <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>    <span class="fu">data_shaper</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-37"><a href="#cb4-37"></a>    <span class="fu">mutate</span>(<span class="at">group_mean =</span> <span class="fu">mean</span>(y,</span>
<span id="cb4-38"><a href="#cb4-38"></a>                             <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-39"><a href="#cb4-39"></a>    <span class="fu">group_by</span>(weekday,</span>
<span id="cb4-40"><a href="#cb4-40"></a>             <span class="at">.add =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-41"><a href="#cb4-41"></a>    <span class="fu">mutate</span>(<span class="at">weekday_mean =</span> <span class="fu">mean</span>(y,</span>
<span id="cb4-42"><a href="#cb4-42"></a>                               <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-43"><a href="#cb4-43"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-44"><a href="#cb4-44"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-45"><a href="#cb4-45"></a>    <span class="fu">aes</span>(<span class="at">x =</span> t,</span>
<span id="cb4-46"><a href="#cb4-46"></a>        <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb4-47"><a href="#cb4-47"></a>    <span class="fu">geom_hline</span>(</span>
<span id="cb4-48"><a href="#cb4-48"></a>      <span class="fu">aes</span>(<span class="at">yintercept =</span> group_mean),</span>
<span id="cb4-49"><a href="#cb4-49"></a>      <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb4-50"><a href="#cb4-50"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.2</span>)</span>
<span id="cb4-51"><a href="#cb4-51"></a>    ) <span class="sc">+</span></span>
<span id="cb4-52"><a href="#cb4-52"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb4-53"><a href="#cb4-53"></a>      <span class="at">color =</span> col_ts,</span>
<span id="cb4-54"><a href="#cb4-54"></a>      <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb4-55"><a href="#cb4-55"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.2</span>)</span>
<span id="cb4-56"><a href="#cb4-56"></a>    ) <span class="sc">+</span></span>
<span id="cb4-57"><a href="#cb4-57"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y),</span>
<span id="cb4-58"><a href="#cb4-58"></a>               <span class="at">color =</span> col_ts.point,</span>
<span id="cb4-59"><a href="#cb4-59"></a>               <span class="at">size =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.12</span>)) <span class="sc">+</span></span>
<span id="cb4-60"><a href="#cb4-60"></a>    <span class="fu">scale_y_continuous</span>(<span class="co"># breaks = breaks_y,</span></span>
<span id="cb4-61"><a href="#cb4-61"></a>      <span class="at">limits =</span> <span class="fu">c</span>(ymin, ymax)) <span class="sc">+</span></span>
<span id="cb4-62"><a href="#cb4-62"></a>    <span class="fu">xlim</span>(<span class="dv">0</span>, max_t) <span class="sc">+</span></span>
<span id="cb4-63"><a href="#cb4-63"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Sequence plot"</span>,</span>
<span id="cb4-64"><a href="#cb4-64"></a>         <span class="at">x =</span> <span class="st">"t"</span>,</span>
<span id="cb4-65"><a href="#cb4-65"></a>         <span class="at">y =</span> <span class="st">"y"</span>)</span>
<span id="cb4-66"><a href="#cb4-66"></a></span>
<span id="cb4-67"><a href="#cb4-67"></a>  <span class="cf">if</span> (remove_titles)</span>
<span id="cb4-68"><a href="#cb4-68"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_blank</span>())</span>
<span id="cb4-69"><a href="#cb4-69"></a>  <span class="cf">if</span> (remove_xlab)</span>
<span id="cb4-70"><a href="#cb4-70"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-71"><a href="#cb4-71"></a>  p_out</span>
<span id="cb4-72"><a href="#cb4-72"></a></span>
<span id="cb4-73"><a href="#cb4-73"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_8bac142eafc8bb5d820a51b98669ea57">
<details>
<summary>Click to reveal <code>plot_dowe()</code></summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>plot_dowe <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-2"><a href="#cb5-2"></a>                      <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-3"><a href="#cb5-3"></a>                      <span class="at">subtitle =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-4"><a href="#cb5-4"></a>                      <span class="at">remove_titles =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-5"><a href="#cb5-5"></a>                      <span class="at">remove_xlab =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-6"><a href="#cb5-6"></a>                      <span class="at">scale_rel =</span> <span class="fl">0.9</span>,</span>
<span id="cb5-7"><a href="#cb5-7"></a>                      <span class="at">max_acf.lag =</span> <span class="dv">35</span>,</span>
<span id="cb5-8"><a href="#cb5-8"></a>                      <span class="at">max_period =</span> <span class="dv">15</span>,</span>
<span id="cb5-9"><a href="#cb5-9"></a>                      <span class="at">ymin =</span> <span class="dv">0</span><span class="fl">-0.1</span>,</span>
<span id="cb5-10"><a href="#cb5-10"></a>                      <span class="at">ymax =</span> <span class="dv">4</span><span class="fl">+0.1</span>,</span>
<span id="cb5-11"><a href="#cb5-11"></a>                      <span class="at">max_t =</span> <span class="dv">140</span>,</span>
<span id="cb5-12"><a href="#cb5-12"></a>                      <span class="at">max_weeks =</span> <span class="dv">25</span>,</span>
<span id="cb5-13"><a href="#cb5-13"></a>                      <span class="at">col_weekly =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb5-14"><a href="#cb5-14"></a>                      <span class="at">col_dowe.line =</span> <span class="st">"mediumorchid4"</span>,</span>
<span id="cb5-15"><a href="#cb5-15"></a>                      <span class="at">col_dowe.point =</span> <span class="st">"deeppink1"</span>,</span>
<span id="cb5-16"><a href="#cb5-16"></a>                      <span class="at">col_ts =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb5-17"><a href="#cb5-17"></a>                      <span class="at">col_ts.point =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb5-18"><a href="#cb5-18"></a>                      <span class="at">col_hist =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb5-19"><a href="#cb5-19"></a>                      <span class="at">col_acf =</span> <span class="st">"darkolivegreen3"</span>,</span>
<span id="cb5-20"><a href="#cb5-20"></a>                      <span class="at">col_pacf =</span> <span class="st">"darkorange3"</span>,</span>
<span id="cb5-21"><a href="#cb5-21"></a>                      <span class="at">col_spec =</span> <span class="st">"darkorchid4"</span>,</span>
<span id="cb5-22"><a href="#cb5-22"></a>                      <span class="at">col_hlines =</span> <span class="st">"dimgray"</span>) {</span>
<span id="cb5-23"><a href="#cb5-23"></a></span>
<span id="cb5-24"><a href="#cb5-24"></a>  <span class="co"># Transforming the input to an appropriate dataframe</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>  d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">data_shaper</span>()</span>
<span id="cb5-26"><a href="#cb5-26"></a></span>
<span id="cb5-27"><a href="#cb5-27"></a>  <span class="co"># Making sure the optimal theme is in place</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>  <span class="fu">theme_set</span>(ggthemes<span class="sc">::</span><span class="fu">theme_few</span>())</span>
<span id="cb5-29"><a href="#cb5-29"></a></span>
<span id="cb5-30"><a href="#cb5-30"></a>  <span class="co"># Making sure the limits are not off</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>  ymin <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">min</span>(d<span class="sc">$</span>y), ymin)</span>
<span id="cb5-32"><a href="#cb5-32"></a>  ymax <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">max</span>(d<span class="sc">$</span>y), ymax)</span>
<span id="cb5-33"><a href="#cb5-33"></a></span>
<span id="cb5-34"><a href="#cb5-34"></a>  p_out <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb5-35"><a href="#cb5-35"></a>    <span class="fu">data_shaper</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-36"><a href="#cb5-36"></a>    <span class="fu">mutate</span>(<span class="at">group_mean =</span> <span class="fu">mean</span>(y,</span>
<span id="cb5-37"><a href="#cb5-37"></a>                             <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>    <span class="fu">group_by</span>(weekday,</span>
<span id="cb5-39"><a href="#cb5-39"></a>             <span class="at">.add =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-40"><a href="#cb5-40"></a>    <span class="fu">mutate</span>(<span class="at">weekday_mean =</span> <span class="fu">mean</span>(y,</span>
<span id="cb5-41"><a href="#cb5-41"></a>                               <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-42"><a href="#cb5-42"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-43"><a href="#cb5-43"></a>    <span class="fu">group_by</span>(week_num,</span>
<span id="cb5-44"><a href="#cb5-44"></a>             <span class="at">.add =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-45"><a href="#cb5-45"></a>    <span class="fu">filter</span>(week_num <span class="sc">&lt;=</span> max_weeks) <span class="sc">%&gt;%</span></span>
<span id="cb5-46"><a href="#cb5-46"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-47"><a href="#cb5-47"></a>    <span class="fu">aes</span>(<span class="at">x =</span> weekday,</span>
<span id="cb5-48"><a href="#cb5-48"></a>        <span class="at">y =</span> y,</span>
<span id="cb5-49"><a href="#cb5-49"></a>        <span class="at">group =</span> week_num) <span class="sc">+</span></span>
<span id="cb5-50"><a href="#cb5-50"></a>    <span class="fu">geom_hline</span>(</span>
<span id="cb5-51"><a href="#cb5-51"></a>      <span class="fu">aes</span>(<span class="at">yintercept =</span> group_mean),</span>
<span id="cb5-52"><a href="#cb5-52"></a>      <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb5-53"><a href="#cb5-53"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.2</span>),</span>
<span id="cb5-54"><a href="#cb5-54"></a>      <span class="at">alpha =</span> <span class="dv">1</span></span>
<span id="cb5-55"><a href="#cb5-55"></a>    ) <span class="sc">+</span></span>
<span id="cb5-56"><a href="#cb5-56"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb5-57"><a href="#cb5-57"></a>      <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb5-58"><a href="#cb5-58"></a>      <span class="at">color =</span> col_weekly,</span>
<span id="cb5-59"><a href="#cb5-59"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.4</span>)</span>
<span id="cb5-60"><a href="#cb5-60"></a>    ) <span class="sc">+</span></span>
<span id="cb5-61"><a href="#cb5-61"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y),</span>
<span id="cb5-62"><a href="#cb5-62"></a>               <span class="at">alpha =</span> <span class="fl">0.6</span>,</span>
<span id="cb5-63"><a href="#cb5-63"></a>               <span class="at">color =</span> col_ts.point,</span>
<span id="cb5-64"><a href="#cb5-64"></a>               <span class="at">size =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.12</span>)) <span class="sc">+</span></span>
<span id="cb5-65"><a href="#cb5-65"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb5-66"><a href="#cb5-66"></a>      <span class="fu">aes</span>(<span class="at">y =</span> weekday_mean),</span>
<span id="cb5-67"><a href="#cb5-67"></a>      <span class="at">color =</span> col_dowe.line,</span>
<span id="cb5-68"><a href="#cb5-68"></a>      <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb5-69"><a href="#cb5-69"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="dv">1</span>)</span>
<span id="cb5-70"><a href="#cb5-70"></a>    ) <span class="sc">+</span></span>
<span id="cb5-71"><a href="#cb5-71"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> weekday_mean),</span>
<span id="cb5-72"><a href="#cb5-72"></a>               <span class="at">color =</span> col_dowe.point,</span>
<span id="cb5-73"><a href="#cb5-73"></a>               <span class="at">size =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb5-74"><a href="#cb5-74"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Weekly plot"</span>,</span>
<span id="cb5-75"><a href="#cb5-75"></a>         <span class="at">x =</span> <span class="st">"Weekdays"</span>,</span>
<span id="cb5-76"><a href="#cb5-76"></a>         <span class="at">y =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb5-77"><a href="#cb5-77"></a>    <span class="fu">scale_y_continuous</span>(<span class="co">#breaks = breaks_y,</span></span>
<span id="cb5-78"><a href="#cb5-78"></a>      <span class="at">limits =</span> <span class="fu">c</span>(ymin, ymax)) <span class="sc">+</span></span>
<span id="cb5-79"><a href="#cb5-79"></a>    <span class="fu">theme</span>(<span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb5-80"><a href="#cb5-80"></a>          <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb5-81"><a href="#cb5-81"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>,</span>
<span id="cb5-82"><a href="#cb5-82"></a>                                     <span class="at">size =</span> <span class="fu">rel</span>(<span class="dv">1</span> <span class="sc">*</span> scale_rel)))</span>
<span id="cb5-83"><a href="#cb5-83"></a></span>
<span id="cb5-84"><a href="#cb5-84"></a>  <span class="cf">if</span> (remove_titles)</span>
<span id="cb5-85"><a href="#cb5-85"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_blank</span>())</span>
<span id="cb5-86"><a href="#cb5-86"></a>  <span class="cf">if</span> (remove_xlab)</span>
<span id="cb5-87"><a href="#cb5-87"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-88"><a href="#cb5-88"></a>  p_out</span>
<span id="cb5-89"><a href="#cb5-89"></a></span>
<span id="cb5-90"><a href="#cb5-90"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-8_7ba9bac4222cf51b2f68176d6b76fbbf">
<details>
<summary>Click to reveal <code>plot_psd()</code></summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>plot_psd <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-2"><a href="#cb6-2"></a>                     <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-3"><a href="#cb6-3"></a>                     <span class="at">subtitle =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-4"><a href="#cb6-4"></a>                     <span class="at">remove_titles =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-5"><a href="#cb6-5"></a>                     <span class="at">remove_xlab =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-6"><a href="#cb6-6"></a>                     <span class="at">scale_rel =</span> <span class="fl">0.9</span>,</span>
<span id="cb6-7"><a href="#cb6-7"></a>                     <span class="at">max_acf.lag =</span> <span class="dv">35</span>,</span>
<span id="cb6-8"><a href="#cb6-8"></a>                     <span class="at">max_period =</span> <span class="dv">15</span>,</span>
<span id="cb6-9"><a href="#cb6-9"></a>                     <span class="at">ymin =</span> <span class="dv">0</span><span class="fl">-0.1</span>,</span>
<span id="cb6-10"><a href="#cb6-10"></a>                     <span class="at">ymax =</span> <span class="dv">4</span><span class="fl">+0.1</span>,</span>
<span id="cb6-11"><a href="#cb6-11"></a>                     <span class="at">max_t =</span> <span class="dv">140</span>,</span>
<span id="cb6-12"><a href="#cb6-12"></a>                     <span class="at">max_weeks =</span> <span class="dv">25</span>,</span>
<span id="cb6-13"><a href="#cb6-13"></a>                     <span class="at">col_weekly =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb6-14"><a href="#cb6-14"></a>                     <span class="at">col_dowe.line =</span> <span class="st">"mediumorchid4"</span>,</span>
<span id="cb6-15"><a href="#cb6-15"></a>                     <span class="at">col_dowe.point =</span> <span class="st">"deeppink1"</span>,</span>
<span id="cb6-16"><a href="#cb6-16"></a>                     <span class="at">col_ts =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb6-17"><a href="#cb6-17"></a>                     <span class="at">col_ts.point =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb6-18"><a href="#cb6-18"></a>                     <span class="at">col_hist =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb6-19"><a href="#cb6-19"></a>                     <span class="at">col_acf =</span> <span class="st">"darkolivegreen3"</span>,</span>
<span id="cb6-20"><a href="#cb6-20"></a>                     <span class="at">col_pacf =</span> <span class="st">"darkorange3"</span>,</span>
<span id="cb6-21"><a href="#cb6-21"></a>                     <span class="at">col_spec =</span> <span class="st">"darkorchid4"</span>,</span>
<span id="cb6-22"><a href="#cb6-22"></a>                     <span class="at">col_hlines =</span> <span class="st">"dimgray"</span>) {</span>
<span id="cb6-23"><a href="#cb6-23"></a></span>
<span id="cb6-24"><a href="#cb6-24"></a>  <span class="co"># Transforming the input to an appropriate dataframe</span></span>
<span id="cb6-25"><a href="#cb6-25"></a>  d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">data_shaper</span>()</span>
<span id="cb6-26"><a href="#cb6-26"></a></span>
<span id="cb6-27"><a href="#cb6-27"></a>  <span class="co"># Making sure the optimal theme is in place</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>  <span class="fu">theme_set</span>(ggthemes<span class="sc">::</span><span class="fu">theme_few</span>())</span>
<span id="cb6-29"><a href="#cb6-29"></a></span>
<span id="cb6-30"><a href="#cb6-30"></a>  <span class="co"># Imputing the missing values using seasonal Kalman smoothing</span></span>
<span id="cb6-31"><a href="#cb6-31"></a>  y_imp <span class="ot">&lt;-</span> d<span class="sc">$</span>y <span class="sc">%&gt;%</span></span>
<span id="cb6-32"><a href="#cb6-32"></a>    <span class="fu">ts</span>(<span class="at">frequency =</span> <span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>    imputeTS<span class="sc">::</span><span class="fu">na_kalman</span>()</span>
<span id="cb6-34"><a href="#cb6-34"></a></span>
<span id="cb6-35"><a href="#cb6-35"></a>  <span class="do">## Calculate Fourier components</span></span>
<span id="cb6-36"><a href="#cb6-36"></a>  y_imp <span class="ot">&lt;-</span> y_imp <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb6-37"><a href="#cb6-37"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y_imp)</span>
<span id="cb6-38"><a href="#cb6-38"></a>  Freq <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span>n <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> n</span>
<span id="cb6-39"><a href="#cb6-39"></a>  var_component <span class="ot">&lt;-</span> <span class="fu">Mod</span>(<span class="fu">fft</span>(<span class="fu">scale</span>(y_imp, <span class="at">scale =</span> <span class="cn">FALSE</span>))) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">/</span> n<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb6-40"><a href="#cb6-40"></a>  df_fourier <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Freq =</span> Freq,</span>
<span id="cb6-41"><a href="#cb6-41"></a>                           <span class="at">rel_power =</span> <span class="dv">100</span><span class="sc">*</span>var_component<span class="sc">/</span><span class="fu">var</span>(y_imp))<span class="sc">%&gt;%</span></span>
<span id="cb6-42"><a href="#cb6-42"></a>    <span class="fu">mutate</span>(<span class="at">Period =</span> <span class="fu">round</span>(<span class="dv">1</span> <span class="sc">/</span> Freq, <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-43"><a href="#cb6-43"></a>    <span class="fu">filter</span>(Freq <span class="sc">!=</span> <span class="dv">0</span>,</span>
<span id="cb6-44"><a href="#cb6-44"></a>           Freq <span class="sc">&lt;=</span> <span class="fl">0.5</span>,</span>
<span id="cb6-45"><a href="#cb6-45"></a>           Period <span class="sc">&lt;=</span> max_period) <span class="sc">%&gt;%</span></span>
<span id="cb6-46"><a href="#cb6-46"></a>    <span class="fu">summarise</span>(<span class="at">rel_power =</span> <span class="fu">sum</span>(rel_power),</span>
<span id="cb6-47"><a href="#cb6-47"></a>              <span class="at">.by =</span> Period) <span class="sc">%&gt;%</span></span>
<span id="cb6-48"><a href="#cb6-48"></a>    <span class="fu">mutate</span>(<span class="at">Freq =</span> <span class="dv">1</span> <span class="sc">/</span> Period,</span>
<span id="cb6-49"><a href="#cb6-49"></a>           <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb6-50"><a href="#cb6-50"></a></span>
<span id="cb6-51"><a href="#cb6-51"></a>  max_var_component <span class="ot">&lt;-</span> <span class="fu">max</span>(df_fourier<span class="sc">$</span>rel_power)</span>
<span id="cb6-52"><a href="#cb6-52"></a></span>
<span id="cb6-53"><a href="#cb6-53"></a>  p_out <span class="ot">&lt;-</span> df_fourier <span class="sc">%&gt;%</span></span>
<span id="cb6-54"><a href="#cb6-54"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb6-55"><a href="#cb6-55"></a>    <span class="fu">aes</span>(</span>
<span id="cb6-56"><a href="#cb6-56"></a>      <span class="at">x =</span> Period,</span>
<span id="cb6-57"><a href="#cb6-57"></a>      <span class="at">xend =</span> Period,</span>
<span id="cb6-58"><a href="#cb6-58"></a>      <span class="at">y =</span> rel_power,</span>
<span id="cb6-59"><a href="#cb6-59"></a>      <span class="at">yend =</span> <span class="dv">0</span></span>
<span id="cb6-60"><a href="#cb6-60"></a>    ) <span class="sc">+</span></span>
<span id="cb6-61"><a href="#cb6-61"></a>    <span class="fu">geom_rect</span>(</span>
<span id="cb6-62"><a href="#cb6-62"></a>      <span class="fu">aes</span>(</span>
<span id="cb6-63"><a href="#cb6-63"></a>        <span class="at">xmin =</span> <span class="fl">6.5</span>,</span>
<span id="cb6-64"><a href="#cb6-64"></a>        <span class="at">xmax =</span> <span class="fl">7.5</span>,</span>
<span id="cb6-65"><a href="#cb6-65"></a>        <span class="at">ymin =</span> <span class="dv">0</span>,</span>
<span id="cb6-66"><a href="#cb6-66"></a>        <span class="at">ymax =</span> <span class="cn">Inf</span></span>
<span id="cb6-67"><a href="#cb6-67"></a>      ),</span>
<span id="cb6-68"><a href="#cb6-68"></a>      <span class="at">alpha =</span> <span class="fl">0.7</span>,</span>
<span id="cb6-69"><a href="#cb6-69"></a>      <span class="at">fill =</span> <span class="st">"azure2"</span></span>
<span id="cb6-70"><a href="#cb6-70"></a>    ) <span class="sc">+</span></span>
<span id="cb6-71"><a href="#cb6-71"></a>    <span class="fu">geom_segment</span>(<span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.5</span>),</span>
<span id="cb6-72"><a href="#cb6-72"></a>                 <span class="at">color =</span> col_spec) <span class="sc">+</span></span>
<span id="cb6-73"><a href="#cb6-73"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span></span>
<span id="cb6-74"><a href="#cb6-74"></a>                         <span class="fu">seq</span>(<span class="dv">0</span>,</span>
<span id="cb6-75"><a href="#cb6-75"></a>                             max_period <span class="sc">-</span> <span class="fl">0.5</span>,</span>
<span id="cb6-76"><a href="#cb6-76"></a>                             <span class="dv">7</span>)) <span class="sc">+</span></span>
<span id="cb6-77"><a href="#cb6-77"></a>    <span class="fu">scale_y_continuous</span>(<span class="co"># labels = scaleFUN,</span></span>
<span id="cb6-78"><a href="#cb6-78"></a>      <span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">breaks_pretty</span>(<span class="dv">4</span>),</span>
<span id="cb6-79"><a href="#cb6-79"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="dv">1</span>, max_var_component))) <span class="sc">+</span></span>
<span id="cb6-80"><a href="#cb6-80"></a>    <span class="fu">theme</span>(</span>
<span id="cb6-81"><a href="#cb6-81"></a>      <span class="co"># axis.title.y = element_blank(),</span></span>
<span id="cb6-82"><a href="#cb6-82"></a>      <span class="co"># axis.ticks.y = element_blank(),</span></span>
<span id="cb6-83"><a href="#cb6-83"></a>      <span class="co"># axis.line.y = element_blank(),</span></span>
<span id="cb6-84"><a href="#cb6-84"></a>      <span class="co"># axis.text.y = element_blank(),</span></span>
<span id="cb6-85"><a href="#cb6-85"></a>      <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>()</span>
<span id="cb6-86"><a href="#cb6-86"></a>    ) <span class="sc">+</span></span>
<span id="cb6-87"><a href="#cb6-87"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Power spectral density"</span>,</span>
<span id="cb6-88"><a href="#cb6-88"></a>         <span class="at">x =</span> <span class="st">"Period (in days)"</span>,</span>
<span id="cb6-89"><a href="#cb6-89"></a>         <span class="at">y =</span> <span class="st">"% total power"</span>)</span>
<span id="cb6-90"><a href="#cb6-90"></a></span>
<span id="cb6-91"><a href="#cb6-91"></a>  <span class="cf">if</span>(max_var_component <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb6-92"><a href="#cb6-92"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span></span>
<span id="cb6-93"><a href="#cb6-93"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb6-94"><a href="#cb6-94"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb6-95"><a href="#cb6-95"></a></span>
<span id="cb6-96"><a href="#cb6-96"></a>  <span class="cf">if</span> (remove_titles)</span>
<span id="cb6-97"><a href="#cb6-97"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_blank</span>())</span>
<span id="cb6-98"><a href="#cb6-98"></a>  <span class="cf">if</span> (remove_xlab)</span>
<span id="cb6-99"><a href="#cb6-99"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>)</span>
<span id="cb6-100"><a href="#cb6-100"></a>  p_out</span>
<span id="cb6-101"><a href="#cb6-101"></a></span>
<span id="cb6-102"><a href="#cb6-102"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-9_e4e619fc488142de694c6d25c8c512d7">
<details>
<summary>Click to reveal <code>plot_acf()</code></summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>plot_acf <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-2"><a href="#cb7-2"></a>                     <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-3"><a href="#cb7-3"></a>                     <span class="at">subtitle =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-4"><a href="#cb7-4"></a>                     <span class="at">remove_titles =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-5"><a href="#cb7-5"></a>                     <span class="at">remove_xlab =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-6"><a href="#cb7-6"></a>                     <span class="at">scale_rel =</span> <span class="fl">0.9</span>,</span>
<span id="cb7-7"><a href="#cb7-7"></a>                     <span class="at">max_acf.lag =</span> <span class="dv">35</span>,</span>
<span id="cb7-8"><a href="#cb7-8"></a>                     <span class="at">max_period =</span> <span class="dv">15</span>,</span>
<span id="cb7-9"><a href="#cb7-9"></a>                     <span class="at">ymin =</span> <span class="dv">0</span><span class="fl">-0.1</span>,</span>
<span id="cb7-10"><a href="#cb7-10"></a>                     <span class="at">ymax =</span> <span class="dv">4</span><span class="fl">+0.1</span>,</span>
<span id="cb7-11"><a href="#cb7-11"></a>                     <span class="at">max_t =</span> <span class="dv">140</span>,</span>
<span id="cb7-12"><a href="#cb7-12"></a>                     <span class="at">max_weeks =</span> <span class="dv">25</span>,</span>
<span id="cb7-13"><a href="#cb7-13"></a>                     <span class="at">col_weekly =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb7-14"><a href="#cb7-14"></a>                     <span class="at">col_dowe.line =</span> <span class="st">"mediumorchid4"</span>,</span>
<span id="cb7-15"><a href="#cb7-15"></a>                     <span class="at">col_dowe.point =</span> <span class="st">"deeppink1"</span>,</span>
<span id="cb7-16"><a href="#cb7-16"></a>                     <span class="at">col_ts =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb7-17"><a href="#cb7-17"></a>                     <span class="at">col_ts.point =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb7-18"><a href="#cb7-18"></a>                     <span class="at">col_hist =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb7-19"><a href="#cb7-19"></a>                     <span class="at">col_acf =</span> <span class="st">"darkolivegreen3"</span>,</span>
<span id="cb7-20"><a href="#cb7-20"></a>                     <span class="at">col_pacf =</span> <span class="st">"darkorange3"</span>,</span>
<span id="cb7-21"><a href="#cb7-21"></a>                     <span class="at">col_spec =</span> <span class="st">"darkorchid4"</span>,</span>
<span id="cb7-22"><a href="#cb7-22"></a>                     <span class="at">col_hlines =</span> <span class="st">"dimgray"</span>) {</span>
<span id="cb7-23"><a href="#cb7-23"></a></span>
<span id="cb7-24"><a href="#cb7-24"></a>  <span class="co"># Transforming the input to an appropriate dataframe</span></span>
<span id="cb7-25"><a href="#cb7-25"></a>  d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">data_shaper</span>()</span>
<span id="cb7-26"><a href="#cb7-26"></a></span>
<span id="cb7-27"><a href="#cb7-27"></a>  <span class="co"># Making sure the optimal theme is in place</span></span>
<span id="cb7-28"><a href="#cb7-28"></a>  <span class="fu">theme_set</span>(ggthemes<span class="sc">::</span><span class="fu">theme_few</span>())</span>
<span id="cb7-29"><a href="#cb7-29"></a></span>
<span id="cb7-30"><a href="#cb7-30"></a>  <span class="co"># Imputing the missing values using seasonal Kalman smoothing</span></span>
<span id="cb7-31"><a href="#cb7-31"></a>  y_imp <span class="ot">&lt;-</span> d<span class="sc">$</span>y <span class="sc">%&gt;%</span></span>
<span id="cb7-32"><a href="#cb7-32"></a>    <span class="fu">ts</span>(<span class="at">frequency =</span> <span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-33"><a href="#cb7-33"></a>    imputeTS<span class="sc">::</span><span class="fu">na_kalman</span>()</span>
<span id="cb7-34"><a href="#cb7-34"></a></span>
<span id="cb7-35"><a href="#cb7-35"></a>  breaks_acf <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,</span>
<span id="cb7-36"><a href="#cb7-36"></a>                    max_acf.lag,</span>
<span id="cb7-37"><a href="#cb7-37"></a>                    <span class="at">by =</span> <span class="dv">14</span> <span class="sc">*</span> <span class="fu">floor</span>(max_acf.lag <span class="sc">/</span> <span class="dv">7</span> <span class="sc">/</span> <span class="dv">3</span>))</span>
<span id="cb7-38"><a href="#cb7-38"></a></span>
<span id="cb7-39"><a href="#cb7-39"></a>  df_acf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb7-40"><a href="#cb7-40"></a>    <span class="at">lag =</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span>max_acf.lag),</span>
<span id="cb7-41"><a href="#cb7-41"></a>    <span class="at">acf =</span> stats<span class="sc">::</span><span class="fu">acf</span>(y_imp,</span>
<span id="cb7-42"><a href="#cb7-42"></a>                     <span class="at">lag.max =</span> max_acf.lag,</span>
<span id="cb7-43"><a href="#cb7-43"></a>                     <span class="at">plot =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>acf <span class="sc">%&gt;%</span></span>
<span id="cb7-44"><a href="#cb7-44"></a>      <span class="fu">as.numeric</span>()</span>
<span id="cb7-45"><a href="#cb7-45"></a>  )</span>
<span id="cb7-46"><a href="#cb7-46"></a></span>
<span id="cb7-47"><a href="#cb7-47"></a>  p_out <span class="ot">&lt;-</span> df_acf <span class="sc">%&gt;%</span></span>
<span id="cb7-48"><a href="#cb7-48"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lag,</span>
<span id="cb7-49"><a href="#cb7-49"></a>               <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb7-50"><a href="#cb7-50"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb7-51"><a href="#cb7-51"></a>      <span class="fu">aes</span>(</span>
<span id="cb7-52"><a href="#cb7-52"></a>        <span class="at">x =</span> lag,</span>
<span id="cb7-53"><a href="#cb7-53"></a>        <span class="at">xend =</span> lag,</span>
<span id="cb7-54"><a href="#cb7-54"></a>        <span class="at">y =</span> <span class="dv">0</span>,</span>
<span id="cb7-55"><a href="#cb7-55"></a>        <span class="at">yend =</span> acf</span>
<span id="cb7-56"><a href="#cb7-56"></a>      ),</span>
<span id="cb7-57"><a href="#cb7-57"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="dv">35</span> <span class="sc">/</span> max_acf.lag <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb7-58"><a href="#cb7-58"></a>      <span class="at">color =</span> col_acf,</span>
<span id="cb7-59"><a href="#cb7-59"></a>      <span class="at">lineend =</span> <span class="st">"butt"</span></span>
<span id="cb7-60"><a href="#cb7-60"></a>    ) <span class="sc">+</span></span>
<span id="cb7-61"><a href="#cb7-61"></a>    <span class="fu">geom_hline</span>(</span>
<span id="cb7-62"><a href="#cb7-62"></a>      <span class="at">yintercept =</span> <span class="dv">0</span>,</span>
<span id="cb7-63"><a href="#cb7-63"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.3</span>),</span>
<span id="cb7-64"><a href="#cb7-64"></a>      <span class="at">linetype =</span> <span class="st">"solid"</span>,</span>
<span id="cb7-65"><a href="#cb7-65"></a>      <span class="at">color =</span> col_hlines</span>
<span id="cb7-66"><a href="#cb7-66"></a>    ) <span class="sc">+</span></span>
<span id="cb7-67"><a href="#cb7-67"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> breaks_acf) <span class="sc">+</span></span>
<span id="cb7-68"><a href="#cb7-68"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb7-69"><a href="#cb7-69"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">25</span>, <span class="fl">1.1</span>)) <span class="sc">+</span></span>
<span id="cb7-70"><a href="#cb7-70"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"ACF"</span>,</span>
<span id="cb7-71"><a href="#cb7-71"></a>         <span class="at">x =</span> <span class="st">"Lag"</span>,</span>
<span id="cb7-72"><a href="#cb7-72"></a>         <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb7-73"><a href="#cb7-73"></a>    <span class="fu">theme</span>(</span>
<span id="cb7-74"><a href="#cb7-74"></a>      <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb7-75"><a href="#cb7-75"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb7-76"><a href="#cb7-76"></a>    )</span>
<span id="cb7-77"><a href="#cb7-77"></a></span>
<span id="cb7-78"><a href="#cb7-78"></a>  <span class="cf">if</span> (remove_titles)</span>
<span id="cb7-79"><a href="#cb7-79"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_blank</span>())</span>
<span id="cb7-80"><a href="#cb7-80"></a>  <span class="cf">if</span> (remove_xlab)</span>
<span id="cb7-81"><a href="#cb7-81"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>)</span>
<span id="cb7-82"><a href="#cb7-82"></a>  p_out</span>
<span id="cb7-83"><a href="#cb7-83"></a></span>
<span id="cb7-84"><a href="#cb7-84"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-10_8c9ab18aa2e455caa2544416b769ebaf">
<details>
<summary>Click to reveal <code>plot_pacf()</code></summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>plot_pacf <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-2"><a href="#cb8-2"></a>                      <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-3"><a href="#cb8-3"></a>                      <span class="at">subtitle =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-4"><a href="#cb8-4"></a>                      <span class="at">remove_titles =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-5"><a href="#cb8-5"></a>                      <span class="at">remove_xlab =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-6"><a href="#cb8-6"></a>                      <span class="at">scale_rel =</span> <span class="fl">0.9</span>,</span>
<span id="cb8-7"><a href="#cb8-7"></a>                      <span class="at">max_acf.lag =</span> <span class="dv">35</span>,</span>
<span id="cb8-8"><a href="#cb8-8"></a>                      <span class="at">max_period =</span> <span class="dv">15</span>,</span>
<span id="cb8-9"><a href="#cb8-9"></a>                      <span class="at">ymin =</span> <span class="dv">0</span><span class="fl">-0.1</span>,</span>
<span id="cb8-10"><a href="#cb8-10"></a>                      <span class="at">ymax =</span> <span class="dv">4</span><span class="fl">+0.1</span>,</span>
<span id="cb8-11"><a href="#cb8-11"></a>                      <span class="at">max_t =</span> <span class="dv">140</span>,</span>
<span id="cb8-12"><a href="#cb8-12"></a>                      <span class="at">max_weeks =</span> <span class="dv">25</span>,</span>
<span id="cb8-13"><a href="#cb8-13"></a>                      <span class="at">col_weekly =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb8-14"><a href="#cb8-14"></a>                      <span class="at">col_dowe.line =</span> <span class="st">"mediumorchid4"</span>,</span>
<span id="cb8-15"><a href="#cb8-15"></a>                      <span class="at">col_dowe.point =</span> <span class="st">"deeppink1"</span>,</span>
<span id="cb8-16"><a href="#cb8-16"></a>                      <span class="at">col_ts =</span> <span class="st">"lightsteelblue4"</span>,</span>
<span id="cb8-17"><a href="#cb8-17"></a>                      <span class="at">col_ts.point =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb8-18"><a href="#cb8-18"></a>                      <span class="at">col_hist =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb8-19"><a href="#cb8-19"></a>                      <span class="at">col_acf =</span> <span class="st">"darkolivegreen3"</span>,</span>
<span id="cb8-20"><a href="#cb8-20"></a>                      <span class="at">col_pacf =</span> <span class="st">"darkorange3"</span>,</span>
<span id="cb8-21"><a href="#cb8-21"></a>                      <span class="at">col_spec =</span> <span class="st">"darkorchid4"</span>,</span>
<span id="cb8-22"><a href="#cb8-22"></a>                      <span class="at">col_hlines =</span> <span class="st">"dimgray"</span>) {</span>
<span id="cb8-23"><a href="#cb8-23"></a></span>
<span id="cb8-24"><a href="#cb8-24"></a>  <span class="co"># Transforming the input to an appropriate dataframe</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>  d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">data_shaper</span>()</span>
<span id="cb8-26"><a href="#cb8-26"></a></span>
<span id="cb8-27"><a href="#cb8-27"></a>  <span class="co"># Making sure the optimal theme is in place</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>  <span class="fu">theme_set</span>(ggthemes<span class="sc">::</span><span class="fu">theme_few</span>())</span>
<span id="cb8-29"><a href="#cb8-29"></a></span>
<span id="cb8-30"><a href="#cb8-30"></a>  <span class="co"># Imputing the missing values using seasonal Kalman smoothing</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>  y_imp <span class="ot">&lt;-</span> d<span class="sc">$</span>y <span class="sc">%&gt;%</span></span>
<span id="cb8-32"><a href="#cb8-32"></a>    <span class="fu">ts</span>(<span class="at">frequency =</span> <span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-33"><a href="#cb8-33"></a>    imputeTS<span class="sc">::</span><span class="fu">na_kalman</span>()</span>
<span id="cb8-34"><a href="#cb8-34"></a></span>
<span id="cb8-35"><a href="#cb8-35"></a>  breaks_acf <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,</span>
<span id="cb8-36"><a href="#cb8-36"></a>                    max_acf.lag,</span>
<span id="cb8-37"><a href="#cb8-37"></a>                    <span class="at">by =</span> <span class="dv">14</span> <span class="sc">*</span> <span class="fu">floor</span>(max_acf.lag <span class="sc">/</span> <span class="dv">7</span> <span class="sc">/</span> <span class="dv">3</span>))</span>
<span id="cb8-38"><a href="#cb8-38"></a></span>
<span id="cb8-39"><a href="#cb8-39"></a>  df_pacf <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb8-40"><a href="#cb8-40"></a>    <span class="at">lag =</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span>max_acf.lag),</span>
<span id="cb8-41"><a href="#cb8-41"></a>    <span class="at">pacf =</span> stats<span class="sc">::</span><span class="fu">pacf</span>(y_imp,</span>
<span id="cb8-42"><a href="#cb8-42"></a>                       <span class="at">lag.max =</span> max_acf.lag,</span>
<span id="cb8-43"><a href="#cb8-43"></a>                       <span class="at">plot =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>acf <span class="sc">%&gt;%</span></span>
<span id="cb8-44"><a href="#cb8-44"></a>      <span class="fu">as.numeric</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-45"><a href="#cb8-45"></a>      <span class="fu">c</span>(<span class="dv">0</span>, .)</span>
<span id="cb8-46"><a href="#cb8-46"></a>  )</span>
<span id="cb8-47"><a href="#cb8-47"></a></span>
<span id="cb8-48"><a href="#cb8-48"></a>  p_out <span class="ot">&lt;-</span> df_pacf <span class="sc">%&gt;%</span></span>
<span id="cb8-49"><a href="#cb8-49"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lag,</span>
<span id="cb8-50"><a href="#cb8-50"></a>               <span class="at">y =</span> pacf)) <span class="sc">+</span></span>
<span id="cb8-51"><a href="#cb8-51"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb8-52"><a href="#cb8-52"></a>      <span class="fu">aes</span>(</span>
<span id="cb8-53"><a href="#cb8-53"></a>        <span class="at">x =</span> lag,</span>
<span id="cb8-54"><a href="#cb8-54"></a>        <span class="at">xend =</span> lag,</span>
<span id="cb8-55"><a href="#cb8-55"></a>        <span class="at">y =</span> <span class="dv">0</span>,</span>
<span id="cb8-56"><a href="#cb8-56"></a>        <span class="at">yend =</span> pacf</span>
<span id="cb8-57"><a href="#cb8-57"></a>      ),</span>
<span id="cb8-58"><a href="#cb8-58"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="dv">35</span> <span class="sc">/</span> max_acf.lag <span class="sc">/</span> <span class="dv">2</span>),</span>
<span id="cb8-59"><a href="#cb8-59"></a>      <span class="at">color =</span> col_pacf,</span>
<span id="cb8-60"><a href="#cb8-60"></a>      <span class="at">lineend =</span> <span class="st">"butt"</span></span>
<span id="cb8-61"><a href="#cb8-61"></a>    ) <span class="sc">+</span></span>
<span id="cb8-62"><a href="#cb8-62"></a>    <span class="fu">geom_hline</span>(</span>
<span id="cb8-63"><a href="#cb8-63"></a>      <span class="at">yintercept =</span> <span class="dv">0</span>,</span>
<span id="cb8-64"><a href="#cb8-64"></a>      <span class="at">linewidth =</span> <span class="fu">rel</span>(scale_rel <span class="sc">*</span> <span class="fl">0.3</span>),</span>
<span id="cb8-65"><a href="#cb8-65"></a>      <span class="at">linetype =</span> <span class="st">"solid"</span>,</span>
<span id="cb8-66"><a href="#cb8-66"></a>      <span class="at">color =</span> col_hlines</span>
<span id="cb8-67"><a href="#cb8-67"></a>    ) <span class="sc">+</span></span>
<span id="cb8-68"><a href="#cb8-68"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> breaks_acf) <span class="sc">+</span></span>
<span id="cb8-69"><a href="#cb8-69"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb8-70"><a href="#cb8-70"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">25</span>, <span class="fl">1.1</span>)) <span class="sc">+</span></span>
<span id="cb8-71"><a href="#cb8-71"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"PACF"</span>,</span>
<span id="cb8-72"><a href="#cb8-72"></a>         <span class="at">x =</span> <span class="st">"Lag"</span>,</span>
<span id="cb8-73"><a href="#cb8-73"></a>         <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb8-74"><a href="#cb8-74"></a>    <span class="fu">theme</span>(</span>
<span id="cb8-75"><a href="#cb8-75"></a>      <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-76"><a href="#cb8-76"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb8-77"><a href="#cb8-77"></a>    )</span>
<span id="cb8-78"><a href="#cb8-78"></a></span>
<span id="cb8-79"><a href="#cb8-79"></a>  <span class="cf">if</span> (remove_titles)</span>
<span id="cb8-80"><a href="#cb8-80"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">plot.subtitle =</span> <span class="fu">element_blank</span>())</span>
<span id="cb8-81"><a href="#cb8-81"></a>  <span class="cf">if</span> (remove_xlab)</span>
<span id="cb8-82"><a href="#cb8-82"></a>    p_out <span class="ot">&lt;-</span> p_out <span class="sc">+</span> <span class="fu">xlab</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-83"><a href="#cb8-83"></a>  p_out</span>
<span id="cb8-84"><a href="#cb8-84"></a></span>
<span id="cb8-85"><a href="#cb8-85"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To make sure that the data provided to these functions are in the correct format (with the above-mentioned columns), the function <code>data_shaper()</code> is called within these plotting functions to do the job. This function also amends a new column (<code>week_num</code>) to the dataframe that counts the week number since the start of the time series, which is needed for plotting the DOWEs in <code>plot_dowe()</code>.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-11_3babf870a79fb18298cc4f5851eb9695">
<details>
<summary>Click to reveal <code>data_shaper()</code></summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>data_shaper <span class="ot">&lt;-</span> <span class="cf">function</span>(d) {</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a>  weekdays <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Mon"</span>,</span>
<span id="cb9-4"><a href="#cb9-4"></a>                <span class="st">"Tue"</span>,</span>
<span id="cb9-5"><a href="#cb9-5"></a>                <span class="st">"Wed"</span>,</span>
<span id="cb9-6"><a href="#cb9-6"></a>                <span class="st">"Thu"</span>,</span>
<span id="cb9-7"><a href="#cb9-7"></a>                <span class="st">"Fri"</span>,</span>
<span id="cb9-8"><a href="#cb9-8"></a>                <span class="st">"Sat"</span>,</span>
<span id="cb9-9"><a href="#cb9-9"></a>                <span class="st">"Sun"</span>)</span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.data.frame</span>(d))</span>
<span id="cb9-12"><a href="#cb9-12"></a>    d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-13"><a href="#cb9-13"></a>      <span class="at">t =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(d),</span>
<span id="cb9-14"><a href="#cb9-14"></a>      <span class="at">y =</span> d,</span>
<span id="cb9-15"><a href="#cb9-15"></a>      <span class="at">weekday =</span> <span class="fu">rep</span>(weekdays, <span class="at">length.out =</span> <span class="fu">length</span>(d)),</span>
<span id="cb9-16"><a href="#cb9-16"></a>      <span class="at">week_num =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ceiling</span>(<span class="fu">length</span>(d) <span class="sc">/</span> <span class="dv">7</span>), <span class="at">each =</span> <span class="dv">7</span>)[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(d)]</span>
<span id="cb9-17"><a href="#cb9-17"></a>    )</span>
<span id="cb9-18"><a href="#cb9-18"></a></span>
<span id="cb9-19"><a href="#cb9-19"></a>  <span class="cf">if</span> (<span class="st">"date"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(d))</span>
<span id="cb9-20"><a href="#cb9-20"></a>    d <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb9-21"><a href="#cb9-21"></a>      <span class="fu">mutate</span>(</span>
<span id="cb9-22"><a href="#cb9-22"></a>        <span class="at">weekday =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb9-23"><a href="#cb9-23"></a>                                  <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb9-24"><a href="#cb9-24"></a>                                  <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-25"><a href="#cb9-25"></a>        <span class="at">weekday_num =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb9-26"><a href="#cb9-26"></a>                                      <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb9-27"><a href="#cb9-27"></a>                                      <span class="at">label =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-28"><a href="#cb9-28"></a>      )</span>
<span id="cb9-29"><a href="#cb9-29"></a></span>
<span id="cb9-30"><a href="#cb9-30"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"weekday_num"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(d)))</span>
<span id="cb9-31"><a href="#cb9-31"></a>    d<span class="sc">$</span>weekday_num <span class="ot">&lt;-</span> <span class="fu">match</span>(d<span class="sc">$</span>weekday, weekdays)</span>
<span id="cb9-32"><a href="#cb9-32"></a></span>
<span id="cb9-33"><a href="#cb9-33"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"week_num"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(d))) {</span>
<span id="cb9-34"><a href="#cb9-34"></a>    <span class="co"># Initialize week number and an empty vector to store week numbers</span></span>
<span id="cb9-35"><a href="#cb9-35"></a>    week_number <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb9-36"><a href="#cb9-36"></a>    week_numbers <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(d<span class="sc">$</span>weekday_num))</span>
<span id="cb9-37"><a href="#cb9-37"></a>    <span class="co"># Check if the sequence starts with a day other than Monday and adjust week_number accordingly</span></span>
<span id="cb9-38"><a href="#cb9-38"></a>    <span class="cf">if</span> (d<span class="sc">$</span>weekday_num[<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">1</span>) {</span>
<span id="cb9-39"><a href="#cb9-39"></a>      week_number <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb9-40"><a href="#cb9-40"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-41"><a href="#cb9-41"></a>      week_number <span class="ot">&lt;-</span></span>
<span id="cb9-42"><a href="#cb9-42"></a>        <span class="dv">2</span>  <span class="co"># Start from week 2 if the first day is Monday, to handle edge cases</span></span>
<span id="cb9-43"><a href="#cb9-43"></a>    }</span>
<span id="cb9-44"><a href="#cb9-44"></a>    <span class="co"># Iterate through the days, increasing week number after encountering a Sunday</span></span>
<span id="cb9-45"><a href="#cb9-45"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(d<span class="sc">$</span>weekday_num)) {</span>
<span id="cb9-46"><a href="#cb9-46"></a>      week_numbers[i] <span class="ot">&lt;-</span> week_number</span>
<span id="cb9-47"><a href="#cb9-47"></a>      <span class="cf">if</span> (d<span class="sc">$</span>weekday_num[i] <span class="sc">==</span> <span class="dv">7</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb9-48"><a href="#cb9-48"></a>          i <span class="sc">!=</span> <span class="fu">length</span>(d<span class="sc">$</span>weekday_num)) {</span>
<span id="cb9-49"><a href="#cb9-49"></a>        <span class="co"># Check for Sunday and not the last element</span></span>
<span id="cb9-50"><a href="#cb9-50"></a>        week_number <span class="ot">&lt;-</span> week_number <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb9-51"><a href="#cb9-51"></a>      }</span>
<span id="cb9-52"><a href="#cb9-52"></a>    }</span>
<span id="cb9-53"><a href="#cb9-53"></a>    d<span class="sc">$</span>week_num <span class="ot">&lt;-</span> week_numbers</span>
<span id="cb9-54"><a href="#cb9-54"></a>  }</span>
<span id="cb9-55"><a href="#cb9-55"></a></span>
<span id="cb9-56"><a href="#cb9-56"></a>  <span class="co"># Substituting NA's for implicit missing values</span></span>
<span id="cb9-57"><a href="#cb9-57"></a>  d_out <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb9-58"><a href="#cb9-58"></a>    <span class="fu">right_join</span>(<span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">min</span>(d<span class="sc">$</span>t)<span class="sc">:</span><span class="fu">max</span>(d<span class="sc">$</span>t)),</span>
<span id="cb9-59"><a href="#cb9-59"></a>               <span class="at">by =</span> <span class="st">"t"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-60"><a href="#cb9-60"></a>    <span class="fu">mutate</span>(<span class="at">weekday =</span> weekday <span class="sc">%&gt;%</span> <span class="fu">factor</span>(weekdays)) <span class="sc">%&gt;%</span></span>
<span id="cb9-61"><a href="#cb9-61"></a>    <span class="fu">arrange</span>(t)</span>
<span id="cb9-62"><a href="#cb9-62"></a></span>
<span id="cb9-63"><a href="#cb9-63"></a>  <span class="fu">return</span>(d_out)</span>
<span id="cb9-64"><a href="#cb9-64"></a></span>
<span id="cb9-65"><a href="#cb9-65"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, the function <code>plot_row_assembly()</code> uses the above functions to put them together in a row and returns either the plot, or saves it in a file in the <code>figures</code> folder with dimensions and sizes that render in nice proportions when the plot is saved with a <code>.svg</code> (good for putting in Word or online) or <code>.pdf</code> (good for <span class="math inline">\(\LaTeX\)</span> manuscripts) file formats.</p>
<p>This function takes a list of time series (either as vectors or dataframes) in its <code>list_data</code> argument, and adds vertical labels to each row of the plots with the values passed to <code>list_labels</code>.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-12_dae035b7d380c09902bff1efd08c9459">
<details>
<summary>Click to reveal <code>plot_row_assembly()</code></summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>plot_row_assembly <span class="ot">&lt;-</span> <span class="cf">function</span>(list_data,</span>
<span id="cb10-2"><a href="#cb10-2"></a>                              <span class="at">list_labels =</span> <span class="cn">NULL</span>,</span>
<span id="cb10-3"><a href="#cb10-3"></a>                              <span class="at">save_name =</span> <span class="st">"plot-rows.pdf"</span>,</span>
<span id="cb10-4"><a href="#cb10-4"></a>                              <span class="at">save_dir =</span> <span class="st">"figures"</span>,</span>
<span id="cb10-5"><a href="#cb10-5"></a>                              ...) {</span>
<span id="cb10-6"><a href="#cb10-6"></a>  n_rows <span class="ot">&lt;-</span> <span class="fu">length</span>(list_data)</span>
<span id="cb10-7"><a href="#cb10-7"></a></span>
<span id="cb10-8"><a href="#cb10-8"></a>  l_hist <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-9"><a href="#cb10-9"></a>  l_seq <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-10"><a href="#cb10-10"></a>  l_dowe <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-11"><a href="#cb10-11"></a>  l_psd <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-12"><a href="#cb10-12"></a>  l_acf <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-13"><a href="#cb10-13"></a>  l_pacf <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-14"><a href="#cb10-14"></a></span>
<span id="cb10-15"><a href="#cb10-15"></a>  title_r <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb10-16"><a href="#cb10-16"></a></span>
<span id="cb10-17"><a href="#cb10-17"></a>  <span class="cf">for</span> (r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_rows) {</span>
<span id="cb10-18"><a href="#cb10-18"></a>    d <span class="ot">&lt;-</span> list_data[[r]]</span>
<span id="cb10-19"><a href="#cb10-19"></a></span>
<span id="cb10-20"><a href="#cb10-20"></a>    <span class="cf">if</span> (<span class="fu">length</span>(list_labels) <span class="sc">==</span> n_rows)</span>
<span id="cb10-21"><a href="#cb10-21"></a>      title_r <span class="ot">&lt;-</span> list_labels[[r]]</span>
<span id="cb10-22"><a href="#cb10-22"></a></span>
<span id="cb10-23"><a href="#cb10-23"></a>    rm_titles <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb10-24"><a href="#cb10-24"></a>    rm_xlab <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb10-25"><a href="#cb10-25"></a></span>
<span id="cb10-26"><a href="#cb10-26"></a>    <span class="cf">if</span> (r <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb10-27"><a href="#cb10-27"></a>      rm_titles <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb10-28"><a href="#cb10-28"></a>      rm_xlab <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb10-29"><a href="#cb10-29"></a>    }</span>
<span id="cb10-30"><a href="#cb10-30"></a></span>
<span id="cb10-31"><a href="#cb10-31"></a>    <span class="cf">if</span> (r <span class="sc">==</span> n_rows) {</span>
<span id="cb10-32"><a href="#cb10-32"></a>      rm_titles <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb10-33"><a href="#cb10-33"></a>      rm_xlab <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb10-34"><a href="#cb10-34"></a>    }</span>
<span id="cb10-35"><a href="#cb10-35"></a></span>
<span id="cb10-36"><a href="#cb10-36"></a>    <span class="cf">if</span> (n_rows <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb10-37"><a href="#cb10-37"></a>      rm_titles <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb10-38"><a href="#cb10-38"></a>      rm_xlab <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb10-39"><a href="#cb10-39"></a>    }</span>
<span id="cb10-40"><a href="#cb10-40"></a></span>
<span id="cb10-41"><a href="#cb10-41"></a>    l_hist[[r]] <span class="ot">&lt;-</span>  <span class="co">#label_plot(r) +</span></span>
<span id="cb10-42"><a href="#cb10-42"></a>      <span class="fu">plot_hist</span>(</span>
<span id="cb10-43"><a href="#cb10-43"></a>        d,</span>
<span id="cb10-44"><a href="#cb10-44"></a>        <span class="at">title =</span> title_r,</span>
<span id="cb10-45"><a href="#cb10-45"></a>        <span class="at">remove_titles =</span> rm_titles,</span>
<span id="cb10-46"><a href="#cb10-46"></a>        <span class="at">remove_xlab =</span> rm_xlab,</span>
<span id="cb10-47"><a href="#cb10-47"></a>        ...</span>
<span id="cb10-48"><a href="#cb10-48"></a>      )</span>
<span id="cb10-49"><a href="#cb10-49"></a>    l_seq[[r]] <span class="ot">&lt;-</span>  <span class="fu">plot_seq</span>(d,</span>
<span id="cb10-50"><a href="#cb10-50"></a>                            <span class="at">remove_titles =</span> rm_titles,</span>
<span id="cb10-51"><a href="#cb10-51"></a>                            <span class="at">remove_xlab =</span> rm_xlab,</span>
<span id="cb10-52"><a href="#cb10-52"></a>                            ...)</span>
<span id="cb10-53"><a href="#cb10-53"></a>    l_dowe[[r]] <span class="ot">&lt;-</span>  <span class="fu">plot_dowe</span>(d,</span>
<span id="cb10-54"><a href="#cb10-54"></a>                              <span class="at">remove_titles =</span> rm_titles,</span>
<span id="cb10-55"><a href="#cb10-55"></a>                              <span class="at">remove_xlab =</span> rm_xlab,</span>
<span id="cb10-56"><a href="#cb10-56"></a>                              ...)</span>
<span id="cb10-57"><a href="#cb10-57"></a>    l_psd[[r]] <span class="ot">&lt;-</span>  <span class="fu">plot_psd</span>(d,</span>
<span id="cb10-58"><a href="#cb10-58"></a>                            <span class="at">remove_titles =</span> rm_titles,</span>
<span id="cb10-59"><a href="#cb10-59"></a>                            <span class="at">remove_xlab =</span> rm_xlab,</span>
<span id="cb10-60"><a href="#cb10-60"></a>                            ...)</span>
<span id="cb10-61"><a href="#cb10-61"></a>    l_acf[[r]] <span class="ot">&lt;-</span>  <span class="fu">plot_acf</span>(d,</span>
<span id="cb10-62"><a href="#cb10-62"></a>                            <span class="at">remove_titles =</span> rm_titles,</span>
<span id="cb10-63"><a href="#cb10-63"></a>                            <span class="at">remove_xlab =</span> rm_xlab,</span>
<span id="cb10-64"><a href="#cb10-64"></a>                            ...)</span>
<span id="cb10-65"><a href="#cb10-65"></a>    l_pacf[[r]] <span class="ot">&lt;-</span>  <span class="fu">plot_pacf</span>(d,</span>
<span id="cb10-66"><a href="#cb10-66"></a>                              <span class="at">remove_titles =</span> rm_titles,</span>
<span id="cb10-67"><a href="#cb10-67"></a>                              <span class="at">remove_xlab =</span> rm_xlab,</span>
<span id="cb10-68"><a href="#cb10-68"></a>                              ...)</span>
<span id="cb10-69"><a href="#cb10-69"></a></span>
<span id="cb10-70"><a href="#cb10-70"></a>  }</span>
<span id="cb10-71"><a href="#cb10-71"></a></span>
<span id="cb10-72"><a href="#cb10-72"></a></span>
<span id="cb10-73"><a href="#cb10-73"></a>  p_tot <span class="ot">&lt;-</span> cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb10-74"><a href="#cb10-74"></a>    l_hist <span class="sc">%&gt;%</span> <span class="fu">wrap_plots</span>(<span class="at">ncol =</span> <span class="dv">1</span>),</span>
<span id="cb10-75"><a href="#cb10-75"></a>    l_seq <span class="sc">%&gt;%</span> <span class="fu">wrap_plots</span>(<span class="at">ncol =</span> <span class="dv">1</span>),</span>
<span id="cb10-76"><a href="#cb10-76"></a>    l_dowe <span class="sc">%&gt;%</span> <span class="fu">wrap_plots</span>(<span class="at">ncol =</span> <span class="dv">1</span>),</span>
<span id="cb10-77"><a href="#cb10-77"></a>    l_psd <span class="sc">%&gt;%</span> <span class="fu">wrap_plots</span>(<span class="at">ncol =</span> <span class="dv">1</span>),</span>
<span id="cb10-78"><a href="#cb10-78"></a>    l_acf <span class="sc">%&gt;%</span> <span class="fu">wrap_plots</span>(<span class="at">ncol =</span> <span class="dv">1</span>),</span>
<span id="cb10-79"><a href="#cb10-79"></a>    l_pacf <span class="sc">%&gt;%</span> <span class="fu">wrap_plots</span>(<span class="at">ncol =</span> <span class="dv">1</span>),</span>
<span id="cb10-80"><a href="#cb10-80"></a>    <span class="at">nrow =</span> <span class="dv">1</span>,</span>
<span id="cb10-81"><a href="#cb10-81"></a>    <span class="at">rel_widths =</span> <span class="fu">c</span>(.<span class="dv">75</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb10-82"><a href="#cb10-82"></a>  )</span>
<span id="cb10-83"><a href="#cb10-83"></a></span>
<span id="cb10-84"><a href="#cb10-84"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(save_name))</span>
<span id="cb10-85"><a href="#cb10-85"></a>    <span class="fu">ggsave</span>(</span>
<span id="cb10-86"><a href="#cb10-86"></a>      <span class="fu">here</span>(save_dir, save_name),</span>
<span id="cb10-87"><a href="#cb10-87"></a>      p_tot,</span>
<span id="cb10-88"><a href="#cb10-88"></a>      <span class="at">width =</span> <span class="dv">40</span>,</span>
<span id="cb10-89"><a href="#cb10-89"></a>      <span class="at">height =</span> <span class="dv">4</span> <span class="sc">*</span> n_rows <span class="sc">+</span> <span class="fl">0.5</span>,</span>
<span id="cb10-90"><a href="#cb10-90"></a>      <span class="at">units =</span> <span class="st">"cm"</span></span>
<span id="cb10-91"><a href="#cb10-91"></a>    )</span>
<span id="cb10-92"><a href="#cb10-92"></a>  <span class="cf">else</span></span>
<span id="cb10-93"><a href="#cb10-93"></a>    <span class="fu">return</span>(p_tot)</span>
<span id="cb10-94"><a href="#cb10-94"></a></span>
<span id="cb10-95"><a href="#cb10-95"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sec-simulation" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="sec-simulation"><span class="header-section-number">1.2</span> Simulating time series</h2>
<p>Pure time series (i.e., without time index and weekday) are generated using <code>m_sim()</code> that generate <span class="math inline">\(y_t = \mu_t + a_t\)</span> by adding a deterministic vector <code>mu_t</code> to a stochastic time series <code>a_t</code>. The innovations used in for simulation are generated from a random seed set by <code>seed</code> argument. The arguments <code>burnin</code> indicate the number of samples thrown away as burn-in samples.</p>
<p>The function generates three time-varying versions of <span class="math inline">\(\mu_t\)</span> as explained in the paper in three vectors:</p>
<ul>
<li><p><span class="math inline">\(D_t\)</span> (as <code>d_t_0</code>) based on the weekday means (DOWEs) that are passed as a vector to <code>dowe</code> (default: all zeros);</p></li>
<li><p><span class="math inline">\(W_t\)</span> (as <code>w_t_0</code>) with workdays mean of 0, and weekend effect determined by the argument <code>wee</code>; and</p></li>
<li><p><span class="math inline">\(H_t\)</span> (as <code>h_t_0</code>) with overall mean of 0 and given amplitude <code>amp</code> (default: 0), and peak shift <code>peak_shift</code> (default: 1, for Monday).</p></li>
</ul>
<p>The time-varying mean <code>mu_t</code> is constructed by adding <code>c</code> to <code>d_t_0</code>, <code>w_t_0</code>, <code>h_t_0</code>. This approach allows users to investigate the effect imposing multiple mechanisms for the mean structure <span class="math inline">\(\mu_t\)</span>. Needless to say, <span class="math inline">\(D_t\)</span>, in general, can account for any arbitrary shape in the mean structure; yet, our implementation may come in handy in the Shiny app (see <a href="#sec-sim-shiny">Section&nbsp;1.3</a>).</p>
<p>The stochastic component <span class="math inline">\(a_t\)</span> is generated using <code>sarima::sim_sarima()</code>. Since this function cannot generate white noise process, if no SAR[I]MA component is specified, <code>a_t</code> is generated manually. In our simulation function <code>m_sim()</code> we allow including non-seasonal and seasonal differencing in the model (which we did not discuss in the paper, but implemented in the Shiny app).</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-13_34aefeca1690b932d9a73811ea9f71c8">
<details>
<summary>Click to reveal <code>m_sim()</code></summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>m_sim <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">10000</span>,</span>
<span id="cb11-2"><a href="#cb11-2"></a>                  <span class="at">ar =</span> <span class="dv">0</span>,</span>
<span id="cb11-3"><a href="#cb11-3"></a>                  <span class="at">ma =</span> <span class="dv">0</span>,</span>
<span id="cb11-4"><a href="#cb11-4"></a>                  <span class="at">sar =</span> <span class="dv">0</span>,</span>
<span id="cb11-5"><a href="#cb11-5"></a>                  <span class="at">sma =</span> <span class="dv">0</span>,</span>
<span id="cb11-6"><a href="#cb11-6"></a>                  <span class="at">c =</span> <span class="dv">0</span>,</span>
<span id="cb11-7"><a href="#cb11-7"></a>                  <span class="at">iorder =</span> <span class="dv">0</span>,</span>
<span id="cb11-8"><a href="#cb11-8"></a>                  <span class="at">siorder =</span> <span class="dv">0</span>,</span>
<span id="cb11-9"><a href="#cb11-9"></a>                  <span class="at">sigma2 =</span> <span class="dv">4</span>,</span>
<span id="cb11-10"><a href="#cb11-10"></a>                  <span class="at">dowe =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">7</span>),</span>
<span id="cb11-11"><a href="#cb11-11"></a>                  <span class="at">wee =</span> <span class="dv">0</span>,</span>
<span id="cb11-12"><a href="#cb11-12"></a>                  <span class="at">amp =</span> <span class="dv">0</span>,</span>
<span id="cb11-13"><a href="#cb11-13"></a>                  <span class="at">peak_shift =</span> <span class="dv">1</span>,</span>
<span id="cb11-14"><a href="#cb11-14"></a>                  <span class="at">burnin =</span> <span class="dv">500</span>,</span>
<span id="cb11-15"><a href="#cb11-15"></a>                  <span class="at">seed =</span> <span class="dv">0</span>) {</span>
<span id="cb11-16"><a href="#cb11-16"></a></span>
<span id="cb11-17"><a href="#cb11-17"></a>  <span class="do">## Generating (time-varying) mean structure mu_t</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>  <span class="co"># Generating sequence of d_t</span></span>
<span id="cb11-19"><a href="#cb11-19"></a>  d_t_0 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb11-20"><a href="#cb11-20"></a>    <span class="at">Mon =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb11-21"><a href="#cb11-21"></a>    <span class="at">Tue =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb11-22"><a href="#cb11-22"></a>    <span class="at">Wed =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb11-23"><a href="#cb11-23"></a>    <span class="at">Thu =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb11-24"><a href="#cb11-24"></a>    <span class="at">Fri =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb11-25"><a href="#cb11-25"></a>    <span class="at">Sat =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb11-26"><a href="#cb11-26"></a>    <span class="at">Sun =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">length.out =</span> n)</span>
<span id="cb11-27"><a href="#cb11-27"></a>  ) <span class="sc">%*%</span></span>
<span id="cb11-28"><a href="#cb11-28"></a>    dowe <span class="sc">%&gt;%</span></span>
<span id="cb11-29"><a href="#cb11-29"></a>    <span class="fu">as.numeric</span>()</span>
<span id="cb11-30"><a href="#cb11-30"></a></span>
<span id="cb11-31"><a href="#cb11-31"></a>  <span class="do">## Generating sequence of w_t_0, which is w_t with c = 0</span></span>
<span id="cb11-32"><a href="#cb11-32"></a>  <span class="co"># Making weekday-weekend dummies matrix</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>  w_t_0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="fu">rep</span>(wee, <span class="dv">2</span>)) <span class="sc">%&gt;%</span> <span class="fu">rep</span>(<span class="at">length.out =</span> n)</span>
<span id="cb11-34"><a href="#cb11-34"></a></span>
<span id="cb11-35"><a href="#cb11-35"></a>  <span class="co"># Generating sequence of h_t_0, which is h_t with c = 0</span></span>
<span id="cb11-36"><a href="#cb11-36"></a>  h_t_0 <span class="ot">&lt;-</span> amp<span class="sc">*</span><span class="fu">cos</span>((<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">7</span>)<span class="sc">*</span>((<span class="dv">1</span><span class="sc">:</span>n) <span class="sc">-</span> peak_shift))</span>
<span id="cb11-37"><a href="#cb11-37"></a></span>
<span id="cb11-38"><a href="#cb11-38"></a>  <span class="co"># Adding d_t, h_t, and w_t together for extra capabilities</span></span>
<span id="cb11-39"><a href="#cb11-39"></a>  mu_t <span class="ot">&lt;-</span> c <span class="sc">+</span> d_t_0 <span class="sc">+</span> w_t_0 <span class="sc">+</span> h_t_0</span>
<span id="cb11-40"><a href="#cb11-40"></a></span>
<span id="cb11-41"><a href="#cb11-41"></a>  <span class="do">## Generating stochastic component a_t</span></span>
<span id="cb11-42"><a href="#cb11-42"></a>  <span class="co"># Setting the seed</span></span>
<span id="cb11-43"><a href="#cb11-43"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb11-44"><a href="#cb11-44"></a></span>
<span id="cb11-45"><a href="#cb11-45"></a>  <span class="co"># Making the list of model specifications</span></span>
<span id="cb11-46"><a href="#cb11-46"></a>  l_model <span class="ot">=</span> <span class="fu">list</span>(<span class="at">ar =</span> ar,</span>
<span id="cb11-47"><a href="#cb11-47"></a>                 <span class="at">ma =</span> ma,</span>
<span id="cb11-48"><a href="#cb11-48"></a>                 <span class="at">sar =</span> sar,</span>
<span id="cb11-49"><a href="#cb11-49"></a>                 <span class="at">sma =</span> sma,</span>
<span id="cb11-50"><a href="#cb11-50"></a>                 <span class="at">iorder =</span> iorder,</span>
<span id="cb11-51"><a href="#cb11-51"></a>                 <span class="at">siorder =</span> siorder,</span>
<span id="cb11-52"><a href="#cb11-52"></a>                 <span class="at">nseasons =</span> <span class="dv">7</span>,</span>
<span id="cb11-53"><a href="#cb11-53"></a>                 <span class="at">sigma2 =</span> sigma2</span>
<span id="cb11-54"><a href="#cb11-54"></a>  )</span>
<span id="cb11-55"><a href="#cb11-55"></a></span>
<span id="cb11-56"><a href="#cb11-56"></a>  <span class="co"># simulating the data</span></span>
<span id="cb11-57"><a href="#cb11-57"></a>  <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">abs</span>(<span class="fu">as.numeric</span>(l_model))) <span class="sc">&gt;</span> <span class="dv">7</span> <span class="sc">+</span> sigma2)</span>
<span id="cb11-58"><a href="#cb11-58"></a>    a_t <span class="ot">&lt;-</span> sarima<span class="sc">::</span><span class="fu">sim_sarima</span>(<span class="at">n =</span> n,</span>
<span id="cb11-59"><a href="#cb11-59"></a>                              <span class="at">model =</span> l_model,</span>
<span id="cb11-60"><a href="#cb11-60"></a>                              <span class="at">n.start =</span> burnin)</span>
<span id="cb11-61"><a href="#cb11-61"></a>  <span class="cf">else</span></span>
<span id="cb11-62"><a href="#cb11-62"></a>    a_t <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n <span class="sc">+</span> burnin,</span>
<span id="cb11-63"><a href="#cb11-63"></a>                 <span class="at">mean =</span> <span class="dv">0</span>,</span>
<span id="cb11-64"><a href="#cb11-64"></a>                 <span class="at">sd =</span> <span class="fu">sqrt</span>(sigma2)) <span class="sc">%&gt;%</span></span>
<span id="cb11-65"><a href="#cb11-65"></a>    <span class="fu">tail</span>(n)</span>
<span id="cb11-66"><a href="#cb11-66"></a></span>
<span id="cb11-67"><a href="#cb11-67"></a>  <span class="do">## Making the complete time series</span></span>
<span id="cb11-68"><a href="#cb11-68"></a>  y_t <span class="ot">&lt;-</span> mu_t <span class="sc">+</span> a_t</span>
<span id="cb11-69"><a href="#cb11-69"></a>  <span class="fu">return</span>(y_t)</span>
<span id="cb11-70"><a href="#cb11-70"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sec-sim-shiny" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="sec-sim-shiny"><span class="header-section-number">1.3</span> Shiny app</h2>
<p>To be completed later.</p>
</section>
</section>
<section id="sec-modeling" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Modeling time series data</h1>
<p>There are to functions that are used for analyzing the data: <code>m_fit()</code> does the model fitting, and <code>m_estimates()</code> extracts the parameter estimates and post-processes them to get CIs and information criteria, and, if necessary, performs bootstrapping.</p>
<section id="sec-fitting" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="sec-fitting"><span class="header-section-number">2.1</span> Fitting time series models</h2>
<p>To carry out the analyses in the paper, we wrote a wrapper function called <code>m_fit()</code> around <code>forecast::Arima()</code> with additional capabilities which is a generalization of the code snippets shown in the paper.</p>
<p>This function flexibly determines the model orders by parsing the model name (as they were presented in the paper) passed as a string to <code>model_string</code>, which helps using it in elsewhere, e.g., in a Shiny app.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-14_174c009c50c05612b25c20b2ee9855af">
<details>
<summary>Click to reveal <code>m_fit()</code></summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>m_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(d,</span>
<span id="cb12-2"><a href="#cb12-2"></a>                  <span class="at">model_string =</span> <span class="st">"d + sarma(1,1)(1,1)"</span>,</span>
<span id="cb12-3"><a href="#cb12-3"></a>                  <span class="at">id =</span> <span class="cn">NULL</span>,</span>
<span id="cb12-4"><a href="#cb12-4"></a>                  <span class="at">save_fit =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-5"><a href="#cb12-5"></a>                  <span class="at">save_est =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-6"><a href="#cb12-6"></a>                  <span class="at">save_name =</span> <span class="cn">NULL</span>,</span>
<span id="cb12-7"><a href="#cb12-7"></a>                  <span class="at">save_prefix_fit =</span> <span class="st">"fit"</span>,</span>
<span id="cb12-8"><a href="#cb12-8"></a>                  <span class="at">save_folder_fit =</span> <span class="st">"fits"</span>,</span>
<span id="cb12-9"><a href="#cb12-9"></a>                  <span class="at">save_prefix_est =</span> <span class="st">"est"</span>,</span>
<span id="cb12-10"><a href="#cb12-10"></a>                  <span class="at">save_folder_est =</span> <span class="st">"ests"</span>,</span>
<span id="cb12-11"><a href="#cb12-11"></a>                  ...) {</span>
<span id="cb12-12"><a href="#cb12-12"></a></span>
<span id="cb12-13"><a href="#cb12-13"></a>  model_string <span class="ot">&lt;-</span> model_string <span class="sc">%&gt;%</span></span>
<span id="cb12-14"><a href="#cb12-14"></a>    <span class="fu">tolower</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>    <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">""</span>, .)</span>
<span id="cb12-16"><a href="#cb12-16"></a></span>
<span id="cb12-17"><a href="#cb12-17"></a>  <span class="co"># Extracting mean structure</span></span>
<span id="cb12-18"><a href="#cb12-18"></a>  mu <span class="ot">&lt;-</span> <span class="st">"c"</span></span>
<span id="cb12-19"><a href="#cb12-19"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"d"</span>, model_string, <span class="at">fixed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-20"><a href="#cb12-20"></a>    mu <span class="ot">&lt;-</span> <span class="st">"d"</span></span>
<span id="cb12-21"><a href="#cb12-21"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"w"</span>, model_string, <span class="at">fixed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-22"><a href="#cb12-22"></a>    mu <span class="ot">&lt;-</span> <span class="st">"w"</span></span>
<span id="cb12-23"><a href="#cb12-23"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"h"</span>, model_string, <span class="at">fixed =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-24"><a href="#cb12-24"></a>    mu <span class="ot">&lt;-</span> <span class="st">"h"</span></span>
<span id="cb12-25"><a href="#cb12-25"></a></span>
<span id="cb12-26"><a href="#cb12-26"></a>  <span class="co"># Extracting [S]AR[I]MA orders</span></span>
<span id="cb12-27"><a href="#cb12-27"></a>  orders <span class="ot">&lt;-</span> model_string <span class="sc">%&gt;%</span></span>
<span id="cb12-28"><a href="#cb12-28"></a>    <span class="fu">str_extract_all</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">d+"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-29"><a href="#cb12-29"></a>    <span class="fu">unlist</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-30"><a href="#cb12-30"></a>    <span class="fu">as.numeric</span>()</span>
<span id="cb12-31"><a href="#cb12-31"></a></span>
<span id="cb12-32"><a href="#cb12-32"></a></span>
<span id="cb12-33"><a href="#cb12-33"></a>  <span class="co"># Adding NA to make sure the first element is for Monday</span></span>
<span id="cb12-34"><a href="#cb12-34"></a>  y_t <span class="ot">&lt;-</span> d<span class="sc">$</span>y <span class="sc">%&gt;%</span></span>
<span id="cb12-35"><a href="#cb12-35"></a>    <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, (d<span class="sc">$</span>weekday_num[<span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> <span class="dv">7</span>),</span>
<span id="cb12-36"><a href="#cb12-36"></a>      .)</span>
<span id="cb12-37"><a href="#cb12-37"></a>  <span class="co"># Getting the length of the time series</span></span>
<span id="cb12-38"><a href="#cb12-38"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y_t)</span>
<span id="cb12-39"><a href="#cb12-39"></a></span>
<span id="cb12-40"><a href="#cb12-40"></a>  <span class="do">## Building mu_t</span></span>
<span id="cb12-41"><a href="#cb12-41"></a>  <span class="co"># To make use Arima consistently, instead of changing</span></span>
<span id="cb12-42"><a href="#cb12-42"></a>  <span class="co"># include.mean for mu_y = c, we model mean with a constant</span></span>
<span id="cb12-43"><a href="#cb12-43"></a>  <span class="co"># variable for mu_t</span></span>
<span id="cb12-44"><a href="#cb12-44"></a>  <span class="cf">if</span> (mu <span class="sc">==</span> <span class="st">"c"</span>)</span>
<span id="cb12-45"><a href="#cb12-45"></a>    mu_t <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, n)</span>
<span id="cb12-46"><a href="#cb12-46"></a></span>
<span id="cb12-47"><a href="#cb12-47"></a>  <span class="co"># Making the dummies matrix</span></span>
<span id="cb12-48"><a href="#cb12-48"></a>  <span class="cf">if</span> (mu <span class="sc">==</span> <span class="st">"d"</span>)</span>
<span id="cb12-49"><a href="#cb12-49"></a>    mu_t <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb12-50"><a href="#cb12-50"></a>      <span class="at">Mon =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb12-51"><a href="#cb12-51"></a>      <span class="at">Tue =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb12-52"><a href="#cb12-52"></a>      <span class="at">Wed =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb12-53"><a href="#cb12-53"></a>      <span class="at">Thu =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb12-54"><a href="#cb12-54"></a>      <span class="at">Fri =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb12-55"><a href="#cb12-55"></a>      <span class="at">Sat =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>), <span class="at">length.out =</span> n),</span>
<span id="cb12-56"><a href="#cb12-56"></a>      <span class="at">Sun =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">length.out =</span> n)</span>
<span id="cb12-57"><a href="#cb12-57"></a>    )</span>
<span id="cb12-58"><a href="#cb12-58"></a></span>
<span id="cb12-59"><a href="#cb12-59"></a>  <span class="co"># Making weekday-weekend dummies matrix</span></span>
<span id="cb12-60"><a href="#cb12-60"></a>  <span class="cf">if</span> (mu <span class="sc">==</span> <span class="st">"w"</span>)</span>
<span id="cb12-61"><a href="#cb12-61"></a>    mu_t <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb12-62"><a href="#cb12-62"></a>      <span class="co"># Weekday = rep(c(1, 1, 1, 1, 1, 0, 0), length.out = n),</span></span>
<span id="cb12-63"><a href="#cb12-63"></a>      <span class="at">c =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">length.out =</span> n),</span>
<span id="cb12-64"><a href="#cb12-64"></a>      <span class="at">Weekend =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">length.out =</span> n)</span>
<span id="cb12-65"><a href="#cb12-65"></a>    )</span>
<span id="cb12-66"><a href="#cb12-66"></a></span>
<span id="cb12-67"><a href="#cb12-67"></a>  <span class="co"># Making the harmonic matrix</span></span>
<span id="cb12-68"><a href="#cb12-68"></a>  <span class="cf">if</span> (mu <span class="sc">==</span> <span class="st">"h"</span>)</span>
<span id="cb12-69"><a href="#cb12-69"></a>    mu_t <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb12-70"><a href="#cb12-70"></a>      <span class="at">c =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n),</span>
<span id="cb12-71"><a href="#cb12-71"></a>      <span class="at">a_cos =</span> <span class="fu">cos</span>((<span class="dv">1</span><span class="sc">:</span>n) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb12-72"><a href="#cb12-72"></a>      <span class="at">b_sin =</span> <span class="fu">sin</span>((<span class="dv">1</span><span class="sc">:</span>n) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">7</span>)</span>
<span id="cb12-73"><a href="#cb12-73"></a>    )</span>
<span id="cb12-74"><a href="#cb12-74"></a></span>
<span id="cb12-75"><a href="#cb12-75"></a></span>
<span id="cb12-76"><a href="#cb12-76"></a>  <span class="do">## Defining the model orders from the model string</span></span>
<span id="cb12-77"><a href="#cb12-77"></a>  <span class="co"># Default: white noise</span></span>
<span id="cb12-78"><a href="#cb12-78"></a>  order_daily <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb12-79"><a href="#cb12-79"></a>  <span class="co"># Default: non-seasonal</span></span>
<span id="cb12-80"><a href="#cb12-80"></a>  order_seasonal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb12-81"><a href="#cb12-81"></a>  seasonal <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-82"><a href="#cb12-82"></a></span>
<span id="cb12-83"><a href="#cb12-83"></a>  <span class="co"># Setting orders conditional on the model string</span></span>
<span id="cb12-84"><a href="#cb12-84"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"ar("</span>, model_string, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb12-85"><a href="#cb12-85"></a>    order_daily <span class="ot">&lt;-</span> <span class="fu">c</span>(orders[<span class="dv">1</span>], <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb12-86"><a href="#cb12-86"></a>  }</span>
<span id="cb12-87"><a href="#cb12-87"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"sar("</span>, model_string, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb12-88"><a href="#cb12-88"></a>    order_daily <span class="ot">&lt;-</span> <span class="fu">c</span>(orders[<span class="dv">1</span>], <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb12-89"><a href="#cb12-89"></a>    order_seasonal <span class="ot">&lt;-</span> <span class="fu">c</span>(orders[<span class="dv">2</span>], <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb12-90"><a href="#cb12-90"></a>  }</span>
<span id="cb12-91"><a href="#cb12-91"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"ma("</span>, model_string, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb12-92"><a href="#cb12-92"></a>    order_daily <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, orders[<span class="dv">1</span>])</span>
<span id="cb12-93"><a href="#cb12-93"></a>  }</span>
<span id="cb12-94"><a href="#cb12-94"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"sma("</span>, model_string, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb12-95"><a href="#cb12-95"></a>    order_daily <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, orders[<span class="dv">1</span>])</span>
<span id="cb12-96"><a href="#cb12-96"></a>    order_seasonal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, orders[<span class="dv">2</span>])</span>
<span id="cb12-97"><a href="#cb12-97"></a>  }</span>
<span id="cb12-98"><a href="#cb12-98"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"arma("</span>, model_string, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb12-99"><a href="#cb12-99"></a>    order_daily <span class="ot">&lt;-</span> <span class="fu">c</span>(orders[<span class="dv">1</span>], <span class="dv">0</span>, orders[<span class="dv">2</span>])</span>
<span id="cb12-100"><a href="#cb12-100"></a>  }</span>
<span id="cb12-101"><a href="#cb12-101"></a>  <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"sarma("</span>, model_string, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb12-102"><a href="#cb12-102"></a>    order_daily <span class="ot">&lt;-</span> <span class="fu">c</span>(orders[<span class="dv">1</span>], <span class="dv">0</span>, orders[<span class="dv">2</span>])</span>
<span id="cb12-103"><a href="#cb12-103"></a>    order_seasonal <span class="ot">&lt;-</span> <span class="fu">c</span>(orders[<span class="dv">3</span>], <span class="dv">0</span>, orders[<span class="dv">4</span>])</span>
<span id="cb12-104"><a href="#cb12-104"></a>  }</span>
<span id="cb12-105"><a href="#cb12-105"></a></span>
<span id="cb12-106"><a href="#cb12-106"></a>  <span class="cf">if</span> (<span class="fu">sum</span>(order_seasonal) <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb12-107"><a href="#cb12-107"></a>    seasonal <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">order =</span> order_seasonal,</span>
<span id="cb12-108"><a href="#cb12-108"></a>                     <span class="at">period =</span> <span class="dv">7</span>)</span>
<span id="cb12-109"><a href="#cb12-109"></a></span>
<span id="cb12-110"><a href="#cb12-110"></a>  <span class="do">## Fitting the model to the time series</span></span>
<span id="cb12-111"><a href="#cb12-111"></a>  m <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">Arima</span>(</span>
<span id="cb12-112"><a href="#cb12-112"></a>    y_t,</span>
<span id="cb12-113"><a href="#cb12-113"></a>    <span class="at">order =</span> order_daily,</span>
<span id="cb12-114"><a href="#cb12-114"></a>    <span class="at">seasonal =</span> seasonal,</span>
<span id="cb12-115"><a href="#cb12-115"></a>    <span class="at">xreg =</span> mu_t,</span>
<span id="cb12-116"><a href="#cb12-116"></a>    <span class="at">include.mean =</span> <span class="cn">FALSE</span></span>
<span id="cb12-117"><a href="#cb12-117"></a>  )</span>
<span id="cb12-118"><a href="#cb12-118"></a></span>
<span id="cb12-119"><a href="#cb12-119"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(save_name))</span>
<span id="cb12-120"><a href="#cb12-120"></a>    save_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb12-121"><a href="#cb12-121"></a>      mu,</span>
<span id="cb12-122"><a href="#cb12-122"></a>      <span class="st">"+sarma("</span>,</span>
<span id="cb12-123"><a href="#cb12-123"></a>      order_daily[<span class="dv">1</span>],</span>
<span id="cb12-124"><a href="#cb12-124"></a>      <span class="st">","</span>,</span>
<span id="cb12-125"><a href="#cb12-125"></a>      order_daily[<span class="dv">3</span>],</span>
<span id="cb12-126"><a href="#cb12-126"></a>      <span class="st">")("</span>,</span>
<span id="cb12-127"><a href="#cb12-127"></a>      order_seasonal[<span class="dv">1</span>],</span>
<span id="cb12-128"><a href="#cb12-128"></a>      <span class="st">","</span>,</span>
<span id="cb12-129"><a href="#cb12-129"></a>      order_seasonal[<span class="dv">3</span>],</span>
<span id="cb12-130"><a href="#cb12-130"></a>      <span class="st">")"</span></span>
<span id="cb12-131"><a href="#cb12-131"></a>    )</span>
<span id="cb12-132"><a href="#cb12-132"></a></span>
<span id="cb12-133"><a href="#cb12-133"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(id)) save_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"id-"</span>,</span>
<span id="cb12-134"><a href="#cb12-134"></a>                                       id,</span>
<span id="cb12-135"><a href="#cb12-135"></a>                                       <span class="st">"_"</span>,</span>
<span id="cb12-136"><a href="#cb12-136"></a>                                       save_name)</span>
<span id="cb12-137"><a href="#cb12-137"></a>  <span class="cf">if</span> (save_fit <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-138"><a href="#cb12-138"></a>    <span class="fu">saveRDS</span>(m,</span>
<span id="cb12-139"><a href="#cb12-139"></a>            <span class="at">file =</span> save_name <span class="sc">%&gt;%</span></span>
<span id="cb12-140"><a href="#cb12-140"></a>              <span class="fu">paste0</span>(save_prefix_fit,</span>
<span id="cb12-141"><a href="#cb12-141"></a>                     <span class="st">"_"</span>,</span>
<span id="cb12-142"><a href="#cb12-142"></a>                     .,</span>
<span id="cb12-143"><a href="#cb12-143"></a>                     <span class="st">".rds"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-144"><a href="#cb12-144"></a>              here<span class="sc">::</span><span class="fu">here</span>(save_folder_fit,</span>
<span id="cb12-145"><a href="#cb12-145"></a>                         .))</span>
<span id="cb12-146"><a href="#cb12-146"></a>  <span class="cf">if</span> (save_est <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-147"><a href="#cb12-147"></a>    m <span class="sc">%&gt;%</span></span>
<span id="cb12-148"><a href="#cb12-148"></a>    <span class="fu">m_estimates</span>(...) <span class="sc">%&gt;%</span></span>
<span id="cb12-149"><a href="#cb12-149"></a>    <span class="fu">saveRDS</span>(<span class="at">file =</span> save_name <span class="sc">%&gt;%</span></span>
<span id="cb12-150"><a href="#cb12-150"></a>              <span class="fu">paste0</span>(save_prefix_est,</span>
<span id="cb12-151"><a href="#cb12-151"></a>                     <span class="st">"_"</span>,</span>
<span id="cb12-152"><a href="#cb12-152"></a>                     .,</span>
<span id="cb12-153"><a href="#cb12-153"></a>                     <span class="st">".rds"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-154"><a href="#cb12-154"></a>              here<span class="sc">::</span><span class="fu">here</span>(save_folder_est,</span>
<span id="cb12-155"><a href="#cb12-155"></a>                         .))</span>
<span id="cb12-156"><a href="#cb12-156"></a>  <span class="do">## Returning the model object</span></span>
<span id="cb12-157"><a href="#cb12-157"></a>  <span class="fu">return</span>(m)</span>
<span id="cb12-158"><a href="#cb12-158"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This function can also save the fit object in a folder (specified by <code>save_folder_fit</code>). To streamline the model fitting and post-processing the fit files, <code>m_fit()</code> will call <code>m_estimates()</code> if <code>save_est</code> is set to <code>TRUE</code>.</p>
</section>
<section id="sec-estimates" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="sec-estimates"><span class="header-section-number">2.2</span> Extracting parameter estimates</h2>
<p>The output of <code>m_fit()</code> is a list of class <code>Arima</code> that contains multiple components (see <code>?stats::arima</code> and <code>?forecast::Arima</code>), but does not contain the estimation standard errors and significances. Furthermore, in case <span class="math inline">\(H_t\)</span> is included in the model, the output does not contain estimates for peak shift <span class="math inline">\(\psi\)</span> and amplitude <span class="math inline">\(S\)</span>.</p>
<p>The function <code>m_estimates()</code> extracts the point estimates of the parameters( <code>m$coef</code>) and calculates their estimation standard errors using the estimated variance matrix of the coefficients (<code>m$var.coef</code>), and calculates 2.5% and 97.5% confidence intervals and significance of the estimates, and stores them in a dataframe called <code>estimates</code>. The function returns a list that contains this dataframe as well as a 1-row dataframe <code>information_criteria</code> that includes different information criteria (AIC, AICc, BIC) as well as the absolute value of the log-likelihood (that could have been used as a criterion in model selection, which we did not use in our paper).</p>
<p>In case the harmonic mean structure is in the model, this function also calculates points estimates and their CIs of peak shift <span class="math inline">\(\psi\)</span> and amplitude <span class="math inline">\(S\)</span> by means of bootstrapping by drawing <code>boot_n</code> samples (default: 10000) from the multivariate normal distribution attributable implied by the estimated variance matrix of the coefficients.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-15_7d9985a6169c0ff54fd0d46bc6b459ff">
<details>
<summary>Click to reveal <code>m_estimates()</code></summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>m_estimates <span class="ot">&lt;-</span> <span class="cf">function</span>(m,</span>
<span id="cb13-2"><a href="#cb13-2"></a>                        <span class="at">boot_plot =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-3"><a href="#cb13-3"></a>                        <span class="at">boot_n =</span> <span class="dv">10000</span>,</span>
<span id="cb13-4"><a href="#cb13-4"></a>                        <span class="at">boot_seed =</span> <span class="dv">0</span>) {</span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="co"># Point estimates of the parameters</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>  o_est <span class="ot">&lt;-</span> <span class="fu">coef</span>(m)</span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="co"># Varviance-covariance matrix of the parameter estimates</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>  o_vcov <span class="ot">&lt;-</span> <span class="fu">vcov</span>(m)</span>
<span id="cb13-9"><a href="#cb13-9"></a></span>
<span id="cb13-10"><a href="#cb13-10"></a>  <span class="co"># Changing the name of "xreg" to "c" for mu_t == "c"</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>  xreg_index <span class="ot">&lt;-</span> <span class="fu">names</span>(o_est) <span class="sc">==</span> <span class="st">"xreg"</span></span>
<span id="cb13-12"><a href="#cb13-12"></a>  <span class="fu">names</span>(o_est)[xreg_index] <span class="ot">&lt;-</span> <span class="st">"c"</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>  <span class="fu">rownames</span>(o_vcov)[xreg_index] <span class="ot">&lt;-</span> <span class="st">"c"</span></span>
<span id="cb13-14"><a href="#cb13-14"></a>  <span class="fu">colnames</span>(o_vcov)[xreg_index] <span class="ot">&lt;-</span> <span class="st">"c"</span></span>
<span id="cb13-15"><a href="#cb13-15"></a></span>
<span id="cb13-16"><a href="#cb13-16"></a>  o_sd <span class="ot">&lt;-</span> o_vcov <span class="sc">%&gt;%</span></span>
<span id="cb13-17"><a href="#cb13-17"></a>    <span class="fu">diag</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>    <span class="fu">sqrt</span>()</span>
<span id="cb13-19"><a href="#cb13-19"></a></span>
<span id="cb13-20"><a href="#cb13-20"></a>  <span class="co"># Making the output table</span></span>
<span id="cb13-21"><a href="#cb13-21"></a>  estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-22"><a href="#cb13-22"></a>    <span class="at">parameter =</span> <span class="st">"sigma2"</span>,</span>
<span id="cb13-23"><a href="#cb13-23"></a>    <span class="at">est =</span> m<span class="sc">$</span>sigma2,</span>
<span id="cb13-24"><a href="#cb13-24"></a>    <span class="at">se =</span> <span class="cn">NA</span>,</span>
<span id="cb13-25"><a href="#cb13-25"></a>    <span class="at">CI_2.5 =</span> <span class="cn">NA</span>,</span>
<span id="cb13-26"><a href="#cb13-26"></a>    <span class="at">CI_97.5 =</span> <span class="cn">NA</span>,</span>
<span id="cb13-27"><a href="#cb13-27"></a>    <span class="at">sig =</span> <span class="st">"*"</span></span>
<span id="cb13-28"><a href="#cb13-28"></a>  )</span>
<span id="cb13-29"><a href="#cb13-29"></a>  <span class="fu">rownames</span>(estimates) <span class="ot">&lt;-</span> <span class="st">"sigma2"</span></span>
<span id="cb13-30"><a href="#cb13-30"></a></span>
<span id="cb13-31"><a href="#cb13-31"></a>  <span class="cf">if</span> (<span class="fu">length</span>(o_est) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb13-32"><a href="#cb13-32"></a>    estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">parameter =</span> o_est <span class="sc">%&gt;%</span> names,</span>
<span id="cb13-33"><a href="#cb13-33"></a>                            <span class="at">est =</span> o_est,</span>
<span id="cb13-34"><a href="#cb13-34"></a>                            <span class="at">se =</span> o_sd) <span class="sc">%&gt;%</span></span>
<span id="cb13-35"><a href="#cb13-35"></a>    <span class="fu">mutate</span>(</span>
<span id="cb13-36"><a href="#cb13-36"></a>      <span class="at">CI_2.5 =</span> est <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.025</span>) <span class="sc">*</span> se,</span>
<span id="cb13-37"><a href="#cb13-37"></a>      <span class="at">CI_97.5 =</span> est <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se,</span>
<span id="cb13-38"><a href="#cb13-38"></a>      <span class="at">sig =</span> <span class="fu">case_when</span>(CI_2<span class="fl">.5</span> <span class="sc">*</span> CI_97<span class="fl">.5</span> <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"*"</span>,</span>
<span id="cb13-39"><a href="#cb13-39"></a>                      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"ns"</span>)</span>
<span id="cb13-40"><a href="#cb13-40"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb13-41"><a href="#cb13-41"></a>    <span class="fu">rbind</span>(estimates)</span>
<span id="cb13-42"><a href="#cb13-42"></a></span>
<span id="cb13-43"><a href="#cb13-43"></a>  <span class="fu">rownames</span>(estimates) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb13-44"><a href="#cb13-44"></a></span>
<span id="cb13-45"><a href="#cb13-45"></a>  <span class="co"># Bootstrapping -----------------------------------------------------------</span></span>
<span id="cb13-46"><a href="#cb13-46"></a></span>
<span id="cb13-47"><a href="#cb13-47"></a>  <span class="co"># Checking if h_t was fitted which would require bootstrapping</span></span>
<span id="cb13-48"><a href="#cb13-48"></a>  <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">names</span>(m<span class="sc">$</span>coef) <span class="sc">==</span> <span class="st">"a_cos"</span>,</span>
<span id="cb13-49"><a href="#cb13-49"></a>          <span class="fu">names</span>(m<span class="sc">$</span>coef) <span class="sc">==</span> <span class="st">"b_sin"</span>)) {</span>
<span id="cb13-50"><a href="#cb13-50"></a>    <span class="co"># Selecting est and vcov of only the relevant parameters for h_t</span></span>
<span id="cb13-51"><a href="#cb13-51"></a>    o_est_h <span class="ot">&lt;-</span> o_est[<span class="fu">c</span>(<span class="st">"c"</span>, <span class="st">"a_cos"</span>, <span class="st">"b_sin"</span>)]</span>
<span id="cb13-52"><a href="#cb13-52"></a>    o_vcov_h <span class="ot">&lt;-</span></span>
<span id="cb13-53"><a href="#cb13-53"></a>      o_vcov[<span class="fu">c</span>(<span class="st">"c"</span>, <span class="st">"a_cos"</span>, <span class="st">"b_sin"</span>), <span class="fu">c</span>(<span class="st">"c"</span>, <span class="st">"a_cos"</span>, <span class="st">"b_sin"</span>)]</span>
<span id="cb13-54"><a href="#cb13-54"></a></span>
<span id="cb13-55"><a href="#cb13-55"></a>    <span class="co"># Bootstrap sampling</span></span>
<span id="cb13-56"><a href="#cb13-56"></a>    <span class="fu">set.seed</span>(boot_seed)</span>
<span id="cb13-57"><a href="#cb13-57"></a></span>
<span id="cb13-58"><a href="#cb13-58"></a>    boot_parameters <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(boot_n,</span>
<span id="cb13-59"><a href="#cb13-59"></a>                                     o_est_h,</span>
<span id="cb13-60"><a href="#cb13-60"></a>                                     o_vcov_h)</span>
<span id="cb13-61"><a href="#cb13-61"></a></span>
<span id="cb13-62"><a href="#cb13-62"></a>    boot_c <span class="ot">&lt;-</span> boot_parameters[, <span class="st">"c"</span>]</span>
<span id="cb13-63"><a href="#cb13-63"></a>    boot_a <span class="ot">&lt;-</span> boot_parameters[, <span class="st">"a_cos"</span>]</span>
<span id="cb13-64"><a href="#cb13-64"></a>    boot_b <span class="ot">&lt;-</span> boot_parameters[, <span class="st">"b_sin"</span>]</span>
<span id="cb13-65"><a href="#cb13-65"></a></span>
<span id="cb13-66"><a href="#cb13-66"></a>    boot_s <span class="ot">&lt;-</span> <span class="fu">calc_amp</span>(boot_a, boot_b)</span>
<span id="cb13-67"><a href="#cb13-67"></a>    boot_theta <span class="ot">&lt;-</span> <span class="fu">calc_peak_theta</span>(boot_a, boot_b) <span class="sc">%&gt;%</span></span>
<span id="cb13-68"><a href="#cb13-68"></a>      <span class="fu">as.numeric</span>() <span class="sc">%&gt;%</span> <span class="fu">as.circular</span>()</span>
<span id="cb13-69"><a href="#cb13-69"></a>    boot_theta_quantiles <span class="ot">&lt;-</span> boot_theta <span class="sc">%&gt;%</span></span>
<span id="cb13-70"><a href="#cb13-70"></a>      <span class="fu">as.circular</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-71"><a href="#cb13-71"></a>      <span class="fu">quantile</span>(<span class="fu">c</span>(.<span class="dv">025</span>, .<span class="dv">5</span>, .<span class="dv">975</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-72"><a href="#cb13-72"></a>      <span class="fu">as.numeric</span>()</span>
<span id="cb13-73"><a href="#cb13-73"></a></span>
<span id="cb13-74"><a href="#cb13-74"></a>    boot_psi <span class="ot">&lt;-</span> boot_theta <span class="sc">*</span> <span class="dv">7</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> pi)</span>
<span id="cb13-75"><a href="#cb13-75"></a>    boot_theta_mod <span class="ot">&lt;-</span> boot_theta <span class="sc">%%</span> (<span class="dv">2</span> <span class="sc">*</span> pi)</span>
<span id="cb13-76"><a href="#cb13-76"></a>    <span class="co"># plot(boot_s, boot_theta)</span></span>
<span id="cb13-77"><a href="#cb13-77"></a></span>
<span id="cb13-78"><a href="#cb13-78"></a>    <span class="co"># Bootstrapped summaries</span></span>
<span id="cb13-79"><a href="#cb13-79"></a>    b_c <span class="ot">&lt;-</span> <span class="fu">mean</span>(boot_c)</span>
<span id="cb13-80"><a href="#cb13-80"></a>    b_s <span class="ot">&lt;-</span> <span class="fu">median</span>(boot_s)</span>
<span id="cb13-81"><a href="#cb13-81"></a>    b_s_sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(boot_s)</span>
<span id="cb13-82"><a href="#cb13-82"></a>    b_s_CIs <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(boot_s, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)))</span>
<span id="cb13-83"><a href="#cb13-83"></a>    b_psi <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">median</span>(boot_theta)) <span class="sc">*</span> <span class="dv">7</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> pi)</span>
<span id="cb13-84"><a href="#cb13-84"></a>    b_psi_sd <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">sd</span>(boot_theta)) <span class="sc">*</span> <span class="dv">7</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> pi)</span>
<span id="cb13-85"><a href="#cb13-85"></a>    b_psi_CIs <span class="ot">&lt;-</span></span>
<span id="cb13-86"><a href="#cb13-86"></a>      <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(boot_theta, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))) <span class="sc">*</span> <span class="dv">7</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> pi)</span>
<span id="cb13-87"><a href="#cb13-87"></a></span>
<span id="cb13-88"><a href="#cb13-88"></a>    <span class="co"># Adding the estimates to the table</span></span>
<span id="cb13-89"><a href="#cb13-89"></a>    boot_estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-90"><a href="#cb13-90"></a>      <span class="at">parameter =</span> <span class="fu">c</span>(<span class="st">"amp"</span>, <span class="st">"peak_shift"</span>),</span>
<span id="cb13-91"><a href="#cb13-91"></a>      <span class="at">est =</span> <span class="fu">c</span>(b_s, b_psi),</span>
<span id="cb13-92"><a href="#cb13-92"></a>      <span class="at">se =</span> <span class="fu">c</span>(b_s_sd, b_psi_sd),</span>
<span id="cb13-93"><a href="#cb13-93"></a>      <span class="at">CI_2.5 =</span> <span class="fu">c</span>(b_s_CIs[<span class="dv">1</span>], b_psi_CIs[<span class="dv">1</span>]),</span>
<span id="cb13-94"><a href="#cb13-94"></a>      <span class="at">CI_97.5 =</span> <span class="fu">c</span>(b_s_CIs[<span class="dv">2</span>], b_psi_CIs[<span class="dv">2</span>]),</span>
<span id="cb13-95"><a href="#cb13-95"></a>      <span class="at">sig =</span> <span class="fu">c</span>(<span class="st">"*"</span>, <span class="st">"*"</span>)</span>
<span id="cb13-96"><a href="#cb13-96"></a>    )</span>
<span id="cb13-97"><a href="#cb13-97"></a></span>
<span id="cb13-98"><a href="#cb13-98"></a>    estimates <span class="ot">&lt;-</span> <span class="fu">rbind</span>(estimates, boot_estimates)</span>
<span id="cb13-99"><a href="#cb13-99"></a></span>
<span id="cb13-100"><a href="#cb13-100"></a>    <span class="cf">if</span> (boot_plot) {</span>
<span id="cb13-101"><a href="#cb13-101"></a>      t <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">7</span>, .<span class="dv">1</span>)</span>
<span id="cb13-102"><a href="#cb13-102"></a>      tt <span class="ot">&lt;-</span> <span class="fu">length</span>(t)</span>
<span id="cb13-103"><a href="#cb13-103"></a>      rr <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb13-104"><a href="#cb13-104"></a>      df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-105"><a href="#cb13-105"></a>        <span class="at">r =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>rr, <span class="at">each =</span> tt) <span class="sc">%&gt;%</span> <span class="fu">as.character</span>(),</span>
<span id="cb13-106"><a href="#cb13-106"></a>        <span class="at">c =</span> <span class="fu">rep</span>(boot_c <span class="sc">%&gt;%</span> <span class="fu">head</span>(rr), <span class="at">each =</span> tt),</span>
<span id="cb13-107"><a href="#cb13-107"></a>        <span class="at">s =</span> <span class="fu">rep</span>(boot_s <span class="sc">%&gt;%</span> <span class="fu">head</span>(rr), <span class="at">each =</span> tt),</span>
<span id="cb13-108"><a href="#cb13-108"></a>        <span class="at">psi =</span> <span class="fu">rep</span>(boot_psi <span class="sc">%&gt;%</span> <span class="fu">head</span>(rr), <span class="at">each =</span> tt),</span>
<span id="cb13-109"><a href="#cb13-109"></a>        <span class="at">t =</span> <span class="fu">rep</span>(t, <span class="at">times =</span> rr)</span>
<span id="cb13-110"><a href="#cb13-110"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb13-111"><a href="#cb13-111"></a>        <span class="fu">mutate</span>(<span class="at">h_t =</span> c <span class="sc">+</span> s <span class="sc">*</span> <span class="fu">cos</span>((t <span class="sc">-</span> psi) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">7</span>))</span>
<span id="cb13-112"><a href="#cb13-112"></a></span>
<span id="cb13-113"><a href="#cb13-113"></a>      p_boot <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb13-114"><a href="#cb13-114"></a>        <span class="fu">group_by</span>(r) <span class="sc">%&gt;%</span></span>
<span id="cb13-115"><a href="#cb13-115"></a>        <span class="fu">ggplot</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>,</span>
<span id="cb13-116"><a href="#cb13-116"></a>               <span class="at">lwd =</span> <span class="fl">0.1</span>,</span>
<span id="cb13-117"><a href="#cb13-117"></a>               <span class="at">linetype =</span> <span class="st">"solid"</span>) <span class="sc">+</span></span>
<span id="cb13-118"><a href="#cb13-118"></a>        <span class="fu">aes</span>(<span class="at">x =</span> t,</span>
<span id="cb13-119"><a href="#cb13-119"></a>            <span class="at">y =</span> h_t,</span>
<span id="cb13-120"><a href="#cb13-120"></a>            <span class="at">group =</span> r) <span class="sc">+</span></span>
<span id="cb13-121"><a href="#cb13-121"></a>        <span class="co"># Separate curves for the first 100 bootstrapped samples</span></span>
<span id="cb13-122"><a href="#cb13-122"></a>        <span class="fu">geom_line</span>(<span class="fu">aes</span>(</span>
<span id="cb13-123"><a href="#cb13-123"></a>          <span class="at">x =</span> t,</span>
<span id="cb13-124"><a href="#cb13-124"></a>          <span class="at">y =</span> h_t,</span>
<span id="cb13-125"><a href="#cb13-125"></a>          <span class="at">group =</span> r,</span>
<span id="cb13-126"><a href="#cb13-126"></a>          <span class="at">color =</span> <span class="st">"single_curves"</span></span>
<span id="cb13-127"><a href="#cb13-127"></a>        )) <span class="sc">+</span></span>
<span id="cb13-128"><a href="#cb13-128"></a>        <span class="co"># Average of the separate curves the first 100 bootstrapped samples</span></span>
<span id="cb13-129"><a href="#cb13-129"></a>        <span class="fu">stat_summary</span>(</span>
<span id="cb13-130"><a href="#cb13-130"></a>          <span class="at">fun.y =</span> mean,</span>
<span id="cb13-131"><a href="#cb13-131"></a>          <span class="at">geom =</span> <span class="st">"line"</span>,</span>
<span id="cb13-132"><a href="#cb13-132"></a>          <span class="at">lwd =</span> <span class="fl">1.5</span>,</span>
<span id="cb13-133"><a href="#cb13-133"></a>          <span class="fu">aes</span>(<span class="at">group =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">color =</span> <span class="st">"mean_curve"</span>),</span>
<span id="cb13-134"><a href="#cb13-134"></a>          <span class="at">alpha =</span> <span class="dv">1</span></span>
<span id="cb13-135"><a href="#cb13-135"></a>        ) <span class="sc">+</span></span>
<span id="cb13-136"><a href="#cb13-136"></a>        <span class="co"># Curve calculated by bootstrapping point estimates</span></span>
<span id="cb13-137"><a href="#cb13-137"></a>        <span class="fu">geom_function</span>(</span>
<span id="cb13-138"><a href="#cb13-138"></a>          <span class="at">fun =</span> <span class="cf">function</span>(t)</span>
<span id="cb13-139"><a href="#cb13-139"></a>            b_c <span class="sc">+</span> b_s <span class="sc">*</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">7</span> <span class="sc">*</span> (t <span class="sc">-</span> b_psi)),</span>
<span id="cb13-140"><a href="#cb13-140"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">"boot_curve"</span>),</span>
<span id="cb13-141"><a href="#cb13-141"></a>          <span class="at">linetype =</span> <span class="st">"solid"</span>,</span>
<span id="cb13-142"><a href="#cb13-142"></a>          <span class="at">lwd =</span> .<span class="dv">5</span>,</span>
<span id="cb13-143"><a href="#cb13-143"></a>          <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb13-144"><a href="#cb13-144"></a>        ) <span class="sc">+</span></span>
<span id="cb13-145"><a href="#cb13-145"></a>        <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> b_c <span class="sc">+</span> b_s,</span>
<span id="cb13-146"><a href="#cb13-146"></a>                   <span class="at">color =</span> <span class="st">"red"</span>,</span>
<span id="cb13-147"><a href="#cb13-147"></a>                   <span class="at">linetype =</span> <span class="st">"solid"</span>,</span>
<span id="cb13-148"><a href="#cb13-148"></a>                   <span class="at">lwd =</span> <span class="dv">1</span>,</span>
<span id="cb13-149"><a href="#cb13-149"></a>                   <span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb13-150"><a href="#cb13-150"></a>        <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> b_psi <span class="sc">%%</span> <span class="dv">7</span>,</span>
<span id="cb13-151"><a href="#cb13-151"></a>                   <span class="at">color =</span> <span class="st">"red"</span>,</span>
<span id="cb13-152"><a href="#cb13-152"></a>                   <span class="at">linetype =</span> <span class="st">"solid"</span>,</span>
<span id="cb13-153"><a href="#cb13-153"></a>                   <span class="at">lwd =</span> <span class="dv">1</span>,</span>
<span id="cb13-154"><a href="#cb13-154"></a>                   <span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb13-155"><a href="#cb13-155"></a>        <span class="co"># Curve calculated by a and b point estimates without bootstrapping</span></span>
<span id="cb13-156"><a href="#cb13-156"></a>        <span class="fu">geom_function</span>(</span>
<span id="cb13-157"><a href="#cb13-157"></a>          <span class="at">fun =</span> <span class="cf">function</span>(t)</span>
<span id="cb13-158"><a href="#cb13-158"></a>            o_est_h[<span class="dv">1</span>] <span class="sc">+</span></span>
<span id="cb13-159"><a href="#cb13-159"></a>            o_est_h[<span class="dv">2</span>] <span class="sc">*</span> <span class="fu">cos</span>(t <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb13-160"><a href="#cb13-160"></a>            o_est_h[<span class="dv">3</span>] <span class="sc">*</span> <span class="fu">sin</span>(t <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb13-161"><a href="#cb13-161"></a>          <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">"naive_curve"</span>),</span>
<span id="cb13-162"><a href="#cb13-162"></a>          <span class="at">linetype =</span> <span class="st">"twodash"</span>,</span>
<span id="cb13-163"><a href="#cb13-163"></a>          <span class="at">lwd =</span> .<span class="dv">5</span>,</span>
<span id="cb13-164"><a href="#cb13-164"></a>          <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb13-165"><a href="#cb13-165"></a>        ) <span class="sc">+</span></span>
<span id="cb13-166"><a href="#cb13-166"></a>        <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> o_est_h[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">sqrt</span>(o_est_h[<span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> o_est_h[<span class="dv">3</span>]<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb13-167"><a href="#cb13-167"></a>                   <span class="at">color =</span> <span class="st">"green"</span>,</span>
<span id="cb13-168"><a href="#cb13-168"></a>                   <span class="at">linetype =</span> <span class="st">"twodash"</span>,</span>
<span id="cb13-169"><a href="#cb13-169"></a>                   <span class="at">lwd =</span> <span class="dv">1</span>,</span>
<span id="cb13-170"><a href="#cb13-170"></a>                   <span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb13-171"><a href="#cb13-171"></a>        <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> (<span class="fu">calc_peak_theta</span>(o_est_h[<span class="dv">2</span>], o_est_h[<span class="dv">3</span>])<span class="sc">*</span><span class="dv">7</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>pi)) <span class="sc">%%</span> <span class="dv">7</span>,</span>
<span id="cb13-172"><a href="#cb13-172"></a>                   <span class="at">color =</span> <span class="st">"green"</span>,</span>
<span id="cb13-173"><a href="#cb13-173"></a>                   <span class="at">linetype =</span> <span class="st">"twodash"</span>,</span>
<span id="cb13-174"><a href="#cb13-174"></a>                   <span class="at">lwd =</span> <span class="dv">1</span>,</span>
<span id="cb13-175"><a href="#cb13-175"></a>                   <span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb13-176"><a href="#cb13-176"></a>        <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> (<span class="fu">atan</span>(o_est_h[<span class="dv">3</span>]<span class="sc">/</span>o_est_h[<span class="dv">2</span>])<span class="sc">*</span><span class="dv">7</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>pi)) <span class="sc">%%</span> <span class="dv">7</span>,</span>
<span id="cb13-177"><a href="#cb13-177"></a>                   <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb13-178"><a href="#cb13-178"></a>                   <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb13-179"><a href="#cb13-179"></a>                   <span class="at">lwd =</span> <span class="dv">1</span>,</span>
<span id="cb13-180"><a href="#cb13-180"></a>                   <span class="at">alpha =</span> <span class="fl">0.85</span>)</span>
<span id="cb13-181"><a href="#cb13-181"></a>        <span class="fu">scale_color_manual</span>(</span>
<span id="cb13-182"><a href="#cb13-182"></a>          <span class="at">name =</span> <span class="st">"Y series"</span>,</span>
<span id="cb13-183"><a href="#cb13-183"></a>          <span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb13-184"><a href="#cb13-184"></a>            <span class="st">"single_curves"</span> <span class="ot">=</span> <span class="st">"pink"</span>,</span>
<span id="cb13-185"><a href="#cb13-185"></a>            <span class="st">"mean_curve"</span> <span class="ot">=</span> <span class="st">"darkblue"</span>,</span>
<span id="cb13-186"><a href="#cb13-186"></a>            <span class="st">"boot_curve"</span> <span class="ot">=</span> <span class="st">"red"</span>,</span>
<span id="cb13-187"><a href="#cb13-187"></a>            <span class="st">"naive_curve"</span> <span class="ot">=</span> <span class="st">"green"</span></span>
<span id="cb13-188"><a href="#cb13-188"></a>          )</span>
<span id="cb13-189"><a href="#cb13-189"></a>        )</span>
<span id="cb13-190"><a href="#cb13-190"></a></span>
<span id="cb13-191"><a href="#cb13-191"></a>    }</span>
<span id="cb13-192"><a href="#cb13-192"></a>  }</span>
<span id="cb13-193"><a href="#cb13-193"></a></span>
<span id="cb13-194"><a href="#cb13-194"></a>  estimates[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> estimates[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>] <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">4</span>)</span>
<span id="cb13-195"><a href="#cb13-195"></a></span>
<span id="cb13-196"><a href="#cb13-196"></a>  information_criteria <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-197"><a href="#cb13-197"></a>    <span class="at">AIC =</span> m<span class="sc">$</span>aic,</span>
<span id="cb13-198"><a href="#cb13-198"></a>    <span class="at">AICc =</span> m<span class="sc">$</span>aicc,</span>
<span id="cb13-199"><a href="#cb13-199"></a>    <span class="at">BIC =</span> m<span class="sc">$</span>bic,</span>
<span id="cb13-200"><a href="#cb13-200"></a>    <span class="at">ll_abs =</span> <span class="fu">abs</span>(m<span class="sc">$</span>loglik)</span>
<span id="cb13-201"><a href="#cb13-201"></a>  )</span>
<span id="cb13-202"><a href="#cb13-202"></a></span>
<span id="cb13-203"><a href="#cb13-203"></a>  o <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">estimates =</span> estimates,</span>
<span id="cb13-204"><a href="#cb13-204"></a>            <span class="at">information_criteria =</span> information_criteria)</span>
<span id="cb13-205"><a href="#cb13-205"></a></span>
<span id="cb13-206"><a href="#cb13-206"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"p_boot"</span>))</span>
<span id="cb13-207"><a href="#cb13-207"></a>    o<span class="sc">$</span>boot_plot <span class="ot">&lt;-</span> p_boot</span>
<span id="cb13-208"><a href="#cb13-208"></a></span>
<span id="cb13-209"><a href="#cb13-209"></a>  <span class="fu">return</span>(o)</span>
<span id="cb13-210"><a href="#cb13-210"></a></span>
<span id="cb13-211"><a href="#cb13-211"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The amplitude <span class="math inline">\(S\)</span> and peak shift <span class="math inline">\(\psi\)</span> are respectively calculated by two auxiliary functions, <code>calc_amp()</code> and <code>calc_peak_theta()</code>, which are vectorized (using <code>Vectorize()</code>) to increase the performance when applied to bootstrapped values. Note that <code>calc_peak_theta(a, b)</code> is equivalent to <code>base::atan2(b, a)</code>, which is the <a href="https://en.wikipedia.org/wiki/Atan2">2-argument arctangent function</a>; we explicitly defined this function in our code to mirror the expression provided in Equation 22b of the paper.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-16_2807f2767f8fde2d683960b78759daa9">
<details>
<summary>Click to reveal <code>calc_amp()</code> and <code>calc_peak_theta()</code></summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="do">## Calculating amplitude and</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>calc_amp <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b)</span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">sqrt</span>(a <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> b <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co"># Vectorizing it</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>calc_amp <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(calc_amp)</span>
<span id="cb14-6"><a href="#cb14-6"></a></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="do">## Calculating peak shift</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>calc_peak_theta <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb14-9"><a href="#cb14-9"></a>  theta <span class="ot">&lt;-</span> <span class="fu">atan</span>(b <span class="sc">/</span> a) <span class="sc">+</span> (pi <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">*</span> <span class="fu">sign</span>(b) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">sign</span>(a))</span>
<span id="cb14-10"><a href="#cb14-10"></a>  <span class="co"># psi &lt;- (7*theta/(2*pi)) #%% 7</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>  <span class="co"># psi &lt;- theta</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>  <span class="fu">return</span>(theta)</span>
<span id="cb14-13"><a href="#cb14-13"></a>}</span>
<span id="cb14-14"><a href="#cb14-14"></a>calc_peak_theta <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(calc_peak_theta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that the variable <span class="math inline">\(\psi\)</span> is circular with a period of 7, that is, peak shifts of <span class="math inline">\(\psi\)</span> and <span class="math inline">\(\psi + 7\)</span> and <span class="math inline">\(\psi - 7\)</span> are equivalent, thus its value cannot calculate summary statistics such as mean, median, and quantiles based on its <span class="math inline">\(0 - 7\)</span> values; for instance, an individual with <span class="math inline">\(\psi_1 = 1\)</span> (peaking on Monday) is more similar to someone with <span class="math inline">\(\psi_2 = 6\)</span> (peaking on Saturday) than someone with and <span class="math inline">\(\psi_3 = 4\)</span> (peaking on Thursday). To take the cisrularity of this variable into account, we use <code>circular</code> package <span class="citation" data-cites="lund_2023_CircularCircularStatistics">[@lund_2023_CircularCircularStatistics]</span> that helps us in calculating</p>
<p>This should be noted when calculating the point estimate (either by mean or median) and CIs of the bootstrapped values.</p>
</section>
</section>
<section id="sec-analysis" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Analyzing empirical data</h1>
<section id="sec-empirical-fitting" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="sec-empirical-fitting"><span class="header-section-number">3.1</span> Fitting models to the whole dataset</h2>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-17_ae14a55b7ff125b8d7c077500f0277ee">
<details>
<summary>Click to expand the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>d_w <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data_private/d_w"</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a>d_pa <span class="ot">&lt;-</span> d_w <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="fu">filter</span>(item <span class="sc">==</span> <span class="st">"avg.pa"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-5"><a href="#cb15-5"></a>    <span class="at">weekday =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb15-6"><a href="#cb15-6"></a>                              <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb15-7"><a href="#cb15-7"></a>                              <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb15-8"><a href="#cb15-8"></a>    <span class="at">weekday_num =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb15-9"><a href="#cb15-9"></a>                                  <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb15-10"><a href="#cb15-10"></a>                                  <span class="at">label =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-11"><a href="#cb15-11"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>  <span class="fu">select</span>(id, t, y, date, weekday, weekday_num)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sec-empirical-results" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-empirical-results"><span class="header-section-number">3.2</span> Results</h2>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb16" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb16-1"><a href="#cb16-1"></a><span class="co">---</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="an">title:</span><span class="co"> "Daily dynamics and weekly rhythms"</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="an">subtitle:</span><span class="co"> "Supplemental Materials"</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="an">author:</span><span class="co"> "MH Manuel Haqiqatkhah"</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="an">format:</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co">  html:</span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="co">    code-fold: true</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="co">    code-tools: true</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="co">    output-file: "index.html"</span></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="co">    code-line-numbers: true</span></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="co">    toc: true</span></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="co">    toc-location: body</span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="co">    number-sections: true</span></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="co">    number-offset: -1</span></span>
<span id="cb16-16"><a href="#cb16-16"></a><span class="co">    link-external-newwindow: true</span></span>
<span id="cb16-17"><a href="#cb16-17"></a><span class="co">    toc-depth: 5</span></span>
<span id="cb16-18"><a href="#cb16-18"></a><span class="co">    self-contained: false</span></span>
<span id="cb16-19"><a href="#cb16-19"></a><span class="co">    self-contained-math: false</span></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="co">    code-summary: "Click to expand the code"</span></span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="co">    anchor-sections: true</span></span>
<span id="cb16-22"><a href="#cb16-22"></a><span class="co">    reference-location: document</span></span>
<span id="cb16-23"><a href="#cb16-23"></a><span class="co">    citation-location: document</span></span>
<span id="cb16-24"><a href="#cb16-24"></a><span class="co">    theme:</span></span>
<span id="cb16-25"><a href="#cb16-25"></a><span class="co">      light: litera</span></span>
<span id="cb16-26"><a href="#cb16-26"></a><span class="co">      dark: darkly</span></span>
<span id="cb16-27"><a href="#cb16-27"></a><span class="co">    # comments:</span></span>
<span id="cb16-28"><a href="#cb16-28"></a><span class="co">    #   hypothesis: true</span></span>
<span id="cb16-29"><a href="#cb16-29"></a><span class="co">  pdf:</span></span>
<span id="cb16-30"><a href="#cb16-30"></a><span class="co">    number-sections: true</span></span>
<span id="cb16-31"><a href="#cb16-31"></a><span class="co">    number-depth: 8</span></span>
<span id="cb16-32"><a href="#cb16-32"></a><span class="co">    #number-offset: -1</span></span>
<span id="cb16-33"><a href="#cb16-33"></a><span class="co">    toc: true</span></span>
<span id="cb16-34"><a href="#cb16-34"></a><span class="co">    output-file: Code documentations</span></span>
<span id="cb16-35"><a href="#cb16-35"></a><span class="co">    toc-depth: 8</span></span>
<span id="cb16-36"><a href="#cb16-36"></a><span class="co">## For html</span></span>
<span id="cb16-37"><a href="#cb16-37"></a><span class="an">execute:</span></span>
<span id="cb16-38"><a href="#cb16-38"></a><span class="co">  enabled: true</span></span>
<span id="cb16-39"><a href="#cb16-39"></a><span class="co">  eval: false</span></span>
<span id="cb16-40"><a href="#cb16-40"></a><span class="co">  echo: true</span></span>
<span id="cb16-41"><a href="#cb16-41"></a><span class="co">  include: true</span></span>
<span id="cb16-42"><a href="#cb16-42"></a><span class="co">  warning: false</span></span>
<span id="cb16-43"><a href="#cb16-43"></a><span class="co">  error: false</span></span>
<span id="cb16-44"><a href="#cb16-44"></a><span class="co">  freeze: auto</span></span>
<span id="cb16-45"><a href="#cb16-45"></a><span class="co">  cache: refresh</span></span>
<span id="cb16-46"><a href="#cb16-46"></a><span class="co">## For pdf</span></span>
<span id="cb16-47"><a href="#cb16-47"></a><span class="co"># execute:</span></span>
<span id="cb16-48"><a href="#cb16-48"></a><span class="co">#   enabled: true</span></span>
<span id="cb16-49"><a href="#cb16-49"></a><span class="co">#   echo: false</span></span>
<span id="cb16-50"><a href="#cb16-50"></a><span class="co">#   include: false</span></span>
<span id="cb16-51"><a href="#cb16-51"></a><span class="co">#   warning: false</span></span>
<span id="cb16-52"><a href="#cb16-52"></a><span class="co">#   error: false</span></span>
<span id="cb16-53"><a href="#cb16-53"></a><span class="co">#   freeze: auto</span></span>
<span id="cb16-54"><a href="#cb16-54"></a><span class="co">#   cache: refresh</span></span>
<span id="cb16-55"><a href="#cb16-55"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb16-56"><a href="#cb16-56"></a><span class="co"># bibliography: references.bib</span></span>
<span id="cb16-57"><a href="#cb16-57"></a><span class="co">---</span></span>
<span id="cb16-58"><a href="#cb16-58"></a></span>
<span id="cb16-59"><a href="#cb16-59"></a><span class="fu"># Introduction {#sec-intro}</span></span>
<span id="cb16-60"><a href="#cb16-60"></a></span>
<span id="cb16-61"><a href="#cb16-61"></a>This document contains reproducible code of the manuscript on weekly patterns and dynamics.</span>
<span id="cb16-62"><a href="#cb16-62"></a>Please cite as</span>
<span id="cb16-63"><a href="#cb16-63"></a></span>
<span id="cb16-64"><a href="#cb16-64"></a><span class="at">&gt; citation info</span></span>
<span id="cb16-65"><a href="#cb16-65"></a></span>
<span id="cb16-66"><a href="#cb16-66"></a>This document has two main sections:</span>
<span id="cb16-67"><a href="#cb16-67"></a></span>
<span id="cb16-68"><a href="#cb16-68"></a>In @sec-foundations (corresponding to Sections 1 and 2 of the paper), we show functions used for making the visualizations (@sec-visualization) and generating simulated data the data (@sec-simulation), and we provide the Shiny app accompanying the paper (@sec-sim-shiny).</span>
<span id="cb16-69"><a href="#cb16-69"></a></span>
<span id="cb16-70"><a href="#cb16-70"></a>In @sec-analysis (corresponding to Sections 3 and 4 of the paper) we provide the code for analyzing individual time series according to different models within a single function (@sec-modeling), and show the code used to run the study on the empirical data (@sec-fitting), and the code used to report the results (@sec-results).</span>
<span id="cb16-71"><a href="#cb16-71"></a></span>
<span id="cb16-72"><a href="#cb16-72"></a>Thanks to Dr. Aidan Wright's permission, we are sharing the data used in our study, that is, the average PA scores of 98 individuals (that had less than 50% missingness) from the dataset collected by @wright_2015_DailyInterpersonalAffective in the <span class="in">`data`</span> folder.</span>
<span id="cb16-73"><a href="#cb16-73"></a>The shared dataset does not contain demographic information, and the unique person identifies have been shuffled and stored as <span class="in">`id`</span>.</span>
<span id="cb16-74"><a href="#cb16-74"></a>Other variables in the dataset are the measurement date (<span class="in">`date`</span>), the measurement time (<span class="in">`t`</span>, starting from the first day of the study on 2013-02-11), the average PA time series (<span class="in">`y`</span>), the weekday associated with the measurement date (<span class="in">`weekday`</span>), and the weekday number (<span class="in">`weekday_num`</span>) with Monday being the first day of the week.</span>
<span id="cb16-75"><a href="#cb16-75"></a></span>
<span id="cb16-76"><a href="#cb16-76"></a>but without the demographic information or other variables including dates empirical data used in the study, we store the individual model fits in the <span class="in">`fits`</span> folder within this repository, and their aggregated summaries in the <span class="in">`summaries`</span> folder.</span>
<span id="cb16-77"><a href="#cb16-77"></a></span>
<span id="cb16-78"><a href="#cb16-78"></a>To replicate the study from the scratch, you should first either clone the repository (using <span class="in">`git clone https://github.com/psyguy/WeCycle.git`</span>) or <span class="co">[</span><span class="ot">download the repository as a zip file</span><span class="co">](https://github.com/psyguy/WeCycle/archive/refs/heads/main.zip)</span> and extract it on your machine.</span>
<span id="cb16-79"><a href="#cb16-79"></a>Then you can sequentially run the <span class="in">`.R`</span> files you find in the <span class="in">`scripts`</span> folder.</span>
<span id="cb16-80"><a href="#cb16-80"></a>Instead of running the scripts separately, if you have <span class="co">[</span><span class="ot">Quarto installed</span><span class="co">](https://quarto.org/docs/get-started/)</span>, you can also compile <span class="in">`index.qmd`</span> located in the root directory using Quarto .</span>
<span id="cb16-81"><a href="#cb16-81"></a></span>
<span id="cb16-84"><a href="#cb16-84"></a><span class="in">```{r}</span></span>
<span id="cb16-85"><a href="#cb16-85"></a><span class="co">#| label: setup</span></span>
<span id="cb16-86"><a href="#cb16-86"></a><span class="co">#| echo: false</span></span>
<span id="cb16-87"><a href="#cb16-87"></a><span class="co">#| include: false</span></span>
<span id="cb16-88"><a href="#cb16-88"></a><span class="co">#| eval: true</span></span>
<span id="cb16-89"><a href="#cb16-89"></a><span class="co">#| cache: false</span></span>
<span id="cb16-90"><a href="#cb16-90"></a><span class="co">#| freeze: false</span></span>
<span id="cb16-91"><a href="#cb16-91"></a></span>
<span id="cb16-92"><a href="#cb16-92"></a><span class="fu">library</span>(knitr)</span>
<span id="cb16-93"><a href="#cb16-93"></a></span>
<span id="cb16-94"><a href="#cb16-94"></a>scripts <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">"scripts/"</span>,</span>
<span id="cb16-95"><a href="#cb16-95"></a>                      <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-96"><a href="#cb16-96"></a></span>
<span id="cb16-97"><a href="#cb16-97"></a><span class="fu">sapply</span>(scripts, knitr<span class="sc">::</span>read_chunk)</span>
<span id="cb16-98"><a href="#cb16-98"></a><span class="in">```</span></span>
<span id="cb16-99"><a href="#cb16-99"></a></span>
<span id="cb16-102"><a href="#cb16-102"></a><span class="in">```{r}</span></span>
<span id="cb16-103"><a href="#cb16-103"></a><span class="co">#| include: false</span></span>
<span id="cb16-104"><a href="#cb16-104"></a><span class="co">#| echo: false</span></span>
<span id="cb16-105"><a href="#cb16-105"></a><span class="co">#| eval: false</span></span>
<span id="cb16-106"><a href="#cb16-106"></a></span>
<span id="cb16-107"><a href="#cb16-107"></a><span class="sc">&lt;</span><span class="er">&lt;</span>load_packages<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-108"><a href="#cb16-108"></a><span class="in">```</span></span>
<span id="cb16-109"><a href="#cb16-109"></a></span>
<span id="cb16-110"><a href="#cb16-110"></a><span class="fu"># Foundations {#sec-foundations}</span></span>
<span id="cb16-111"><a href="#cb16-111"></a></span>
<span id="cb16-112"><a href="#cb16-112"></a>The code used for plotting the time series and fitting the models requires the time series $y_t$ to be stored in a data.frame (which, let us call <span class="in">`df`</span>) with at least three columns:</span>
<span id="cb16-113"><a href="#cb16-113"></a></span>
<span id="cb16-114"><a href="#cb16-114"></a><span class="ss">-   </span><span class="in">`t`</span>: Indicating the time of the measurement</span>
<span id="cb16-115"><a href="#cb16-115"></a></span>
<span id="cb16-116"><a href="#cb16-116"></a><span class="ss">-   </span><span class="in">`y`</span>: The value $y_t$ on time $t$</span>
<span id="cb16-117"><a href="#cb16-117"></a></span>
<span id="cb16-118"><a href="#cb16-118"></a><span class="ss">-   </span><span class="in">`weekday`</span> (or <span class="in">`weekday_num`</span>): The name (or number) of the weekday corresponding to <span class="in">`t`</span>.</span>
<span id="cb16-119"><a href="#cb16-119"></a>    In the case of the former, it should be in the form of capitalized three letter codes (<span class="in">`"Mon"`</span>, <span class="in">`"Tue"`</span>, ..., <span class="in">`"Sun"`</span>).</span>
<span id="cb16-120"><a href="#cb16-120"></a>    Note that we consider Monday to be the first day of the week, and Sunday be the 0th/7th day of the week.</span>
<span id="cb16-121"><a href="#cb16-121"></a></span>
<span id="cb16-122"><a href="#cb16-122"></a>The column <span class="in">`weekday`</span> (and <span class="in">`weekday_num`</span>) can be generated if the date (e.g., as <span class="in">`date`</span>) is included in <span class="in">`df`</span>, using <span class="in">`lubridate::wday`</span> and setting:</span>
<span id="cb16-123"><a href="#cb16-123"></a></span>
<span id="cb16-126"><a href="#cb16-126"></a><span class="in">```{r}</span></span>
<span id="cb16-127"><a href="#cb16-127"></a><span class="co">#| code-fold: show</span></span>
<span id="cb16-128"><a href="#cb16-128"></a></span>
<span id="cb16-129"><a href="#cb16-129"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb16-130"><a href="#cb16-130"></a>  <span class="fu">mutate</span>(<span class="at">weekday =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb16-131"><a href="#cb16-131"></a>                                   <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb16-132"><a href="#cb16-132"></a>                                   <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-133"><a href="#cb16-133"></a>         <span class="at">weekday_num =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb16-134"><a href="#cb16-134"></a>                                       <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb16-135"><a href="#cb16-135"></a>                                       <span class="at">label =</span> <span class="cn">FALSE</span>))</span>
<span id="cb16-136"><a href="#cb16-136"></a><span class="in">```</span></span>
<span id="cb16-137"><a href="#cb16-137"></a></span>
<span id="cb16-138"><a href="#cb16-138"></a>The missing values in the time series should be explicitly indicated with <span class="in">`NA`</span> in the dataframe---that is, we should have a row for each time point---which can be achieved by:</span>
<span id="cb16-139"><a href="#cb16-139"></a></span>
<span id="cb16-142"><a href="#cb16-142"></a><span class="in">```{r}</span></span>
<span id="cb16-143"><a href="#cb16-143"></a><span class="co">#| code-fold: show</span></span>
<span id="cb16-144"><a href="#cb16-144"></a></span>
<span id="cb16-145"><a href="#cb16-145"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb16-146"><a href="#cb16-146"></a>  <span class="fu">right_join</span>(<span class="fu">data.frame</span>(<span class="at">t =</span> <span class="fu">min</span>(df<span class="sc">$</span>t)<span class="sc">:</span><span class="fu">max</span>(df<span class="sc">$</span>t)),</span>
<span id="cb16-147"><a href="#cb16-147"></a>             <span class="at">by =</span> <span class="st">"t"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-148"><a href="#cb16-148"></a>  <span class="fu">arrange</span>(t)</span>
<span id="cb16-149"><a href="#cb16-149"></a><span class="in">```</span></span>
<span id="cb16-150"><a href="#cb16-150"></a></span>
<span id="cb16-151"><a href="#cb16-151"></a><span class="fu">## Time series visualizations {#sec-visualization}</span></span>
<span id="cb16-152"><a href="#cb16-152"></a></span>
<span id="cb16-153"><a href="#cb16-153"></a>The visualizations shown in discussed in the paper were plotted using separate functions for each plot, that are named accordingly <span class="in">`plot_hist()`</span> , <span class="in">`plot_seq()`</span>, <span class="in">`plot_dowe()`</span>, <span class="in">`plot_psd()`</span>, <span class="in">`plot_acf()`</span>, and <span class="in">`plot_pacf()`</span>.</span>
<span id="cb16-154"><a href="#cb16-154"></a>The main argument of these functions is <span class="in">`d`</span>, which can be a numerical vector (for which the weekdays are added, starting by Monday), or it can be a dataframe with the columns specifiedexplained earlier.</span>
<span id="cb16-155"><a href="#cb16-155"></a></span>
<span id="cb16-158"><a href="#cb16-158"></a><span class="in">```{r}</span></span>
<span id="cb16-159"><a href="#cb16-159"></a><span class="co">#| eval: true</span></span>
<span id="cb16-160"><a href="#cb16-160"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-161"><a href="#cb16-161"></a><span class="co">#| code-summary: "Click to reveal `plot_hist()`"</span></span>
<span id="cb16-162"><a href="#cb16-162"></a></span>
<span id="cb16-163"><a href="#cb16-163"></a><span class="sc">&lt;</span><span class="er">&lt;</span>plot_hist<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-164"><a href="#cb16-164"></a><span class="in">```</span></span>
<span id="cb16-165"><a href="#cb16-165"></a></span>
<span id="cb16-168"><a href="#cb16-168"></a><span class="in">```{r}</span></span>
<span id="cb16-169"><a href="#cb16-169"></a><span class="co">#| eval: true</span></span>
<span id="cb16-170"><a href="#cb16-170"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-171"><a href="#cb16-171"></a><span class="co">#| code-summary: "Click to reveal `plot_seq()`"</span></span>
<span id="cb16-172"><a href="#cb16-172"></a></span>
<span id="cb16-173"><a href="#cb16-173"></a><span class="sc">&lt;</span><span class="er">&lt;</span>plot_seq<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-174"><a href="#cb16-174"></a><span class="in">```</span></span>
<span id="cb16-175"><a href="#cb16-175"></a></span>
<span id="cb16-178"><a href="#cb16-178"></a><span class="in">```{r}</span></span>
<span id="cb16-179"><a href="#cb16-179"></a><span class="co">#| eval: true</span></span>
<span id="cb16-180"><a href="#cb16-180"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-181"><a href="#cb16-181"></a><span class="co">#| code-summary: "Click to reveal `plot_dowe()`"</span></span>
<span id="cb16-182"><a href="#cb16-182"></a></span>
<span id="cb16-183"><a href="#cb16-183"></a><span class="sc">&lt;</span><span class="er">&lt;</span>plot_dowe<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-184"><a href="#cb16-184"></a><span class="in">```</span></span>
<span id="cb16-185"><a href="#cb16-185"></a></span>
<span id="cb16-188"><a href="#cb16-188"></a><span class="in">```{r}</span></span>
<span id="cb16-189"><a href="#cb16-189"></a><span class="co">#| eval: true</span></span>
<span id="cb16-190"><a href="#cb16-190"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-191"><a href="#cb16-191"></a><span class="co">#| code-summary: "Click to reveal `plot_psd()`"</span></span>
<span id="cb16-192"><a href="#cb16-192"></a></span>
<span id="cb16-193"><a href="#cb16-193"></a><span class="sc">&lt;</span><span class="er">&lt;</span>plot_psd<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-194"><a href="#cb16-194"></a><span class="in">```</span></span>
<span id="cb16-195"><a href="#cb16-195"></a></span>
<span id="cb16-198"><a href="#cb16-198"></a><span class="in">```{r}</span></span>
<span id="cb16-199"><a href="#cb16-199"></a><span class="co">#| eval: true</span></span>
<span id="cb16-200"><a href="#cb16-200"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-201"><a href="#cb16-201"></a><span class="co">#| code-summary: "Click to reveal `plot_acf()`"</span></span>
<span id="cb16-202"><a href="#cb16-202"></a></span>
<span id="cb16-203"><a href="#cb16-203"></a><span class="sc">&lt;</span><span class="er">&lt;</span>plot_acf<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-204"><a href="#cb16-204"></a><span class="in">```</span></span>
<span id="cb16-205"><a href="#cb16-205"></a></span>
<span id="cb16-208"><a href="#cb16-208"></a><span class="in">```{r}</span></span>
<span id="cb16-209"><a href="#cb16-209"></a><span class="co">#| eval: true</span></span>
<span id="cb16-210"><a href="#cb16-210"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-211"><a href="#cb16-211"></a><span class="co">#| code-summary: "Click to reveal `plot_pacf()`"</span></span>
<span id="cb16-212"><a href="#cb16-212"></a></span>
<span id="cb16-213"><a href="#cb16-213"></a><span class="sc">&lt;</span><span class="er">&lt;</span>plot_pacf<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-214"><a href="#cb16-214"></a><span class="in">```</span></span>
<span id="cb16-215"><a href="#cb16-215"></a></span>
<span id="cb16-216"><a href="#cb16-216"></a>To make sure that the data provided to these functions are in the correct format (with the above-mentioned columns), the function <span class="in">`data_shaper()`</span> is called within these plotting functions to do the job.</span>
<span id="cb16-217"><a href="#cb16-217"></a>This function also amends a new column (<span class="in">`week_num`</span>) to the dataframe that counts the week number since the start of the time series, which is needed for plotting the DOWEs in <span class="in">`plot_dowe()`</span>.</span>
<span id="cb16-218"><a href="#cb16-218"></a></span>
<span id="cb16-221"><a href="#cb16-221"></a><span class="in">```{r}</span></span>
<span id="cb16-222"><a href="#cb16-222"></a><span class="co">#| eval: true</span></span>
<span id="cb16-223"><a href="#cb16-223"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-224"><a href="#cb16-224"></a><span class="co">#| code-summary: "Click to reveal `data_shaper()`"</span></span>
<span id="cb16-225"><a href="#cb16-225"></a></span>
<span id="cb16-226"><a href="#cb16-226"></a><span class="sc">&lt;</span><span class="er">&lt;</span>data_shaper<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-227"><a href="#cb16-227"></a><span class="in">```</span></span>
<span id="cb16-228"><a href="#cb16-228"></a></span>
<span id="cb16-229"><a href="#cb16-229"></a>Then, the function <span class="in">`plot_row_assembly()`</span> uses the above functions to put them together in a row and returns either the plot, or saves it in a file in the <span class="in">`figures`</span> folder with dimensions and sizes that render in nice proportions when the plot is saved with a <span class="in">`.svg`</span> (good for putting in Word or online) or <span class="in">`.pdf`</span> (good for $\LaTeX$ manuscripts) file formats.</span>
<span id="cb16-230"><a href="#cb16-230"></a></span>
<span id="cb16-231"><a href="#cb16-231"></a>This function takes a list of time series (either as vectors or dataframes) in its <span class="in">`list_data`</span> argument, and adds vertical labels to each row of the plots with the values passed to <span class="in">`list_labels`</span>.</span>
<span id="cb16-232"><a href="#cb16-232"></a></span>
<span id="cb16-235"><a href="#cb16-235"></a><span class="in">```{r}</span></span>
<span id="cb16-236"><a href="#cb16-236"></a><span class="co">#| eval: true</span></span>
<span id="cb16-237"><a href="#cb16-237"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-238"><a href="#cb16-238"></a><span class="co">#| code-summary: "Click to reveal `plot_row_assembly()`"</span></span>
<span id="cb16-239"><a href="#cb16-239"></a></span>
<span id="cb16-240"><a href="#cb16-240"></a><span class="sc">&lt;</span><span class="er">&lt;</span>plot_row_assembly<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-241"><a href="#cb16-241"></a><span class="in">```</span></span>
<span id="cb16-242"><a href="#cb16-242"></a></span>
<span id="cb16-243"><a href="#cb16-243"></a><span class="fu">## Simulating time series {#sec-simulation}</span></span>
<span id="cb16-244"><a href="#cb16-244"></a></span>
<span id="cb16-245"><a href="#cb16-245"></a>Pure time series (i.e., without time index and weekday) are generated using <span class="in">`m_sim()`</span> that generate $y_t = \mu_t + a_t$ by adding a deterministic vector <span class="in">`mu_t`</span> to a stochastic time series <span class="in">`a_t`</span>.</span>
<span id="cb16-246"><a href="#cb16-246"></a>The innovations used in for simulation are generated from a random seed set by <span class="in">`seed`</span> argument.</span>
<span id="cb16-247"><a href="#cb16-247"></a>The arguments <span class="in">`burnin`</span> indicate the number of samples thrown away as burn-in samples.</span>
<span id="cb16-248"><a href="#cb16-248"></a></span>
<span id="cb16-249"><a href="#cb16-249"></a>The function generates three time-varying versions of $\mu_t$ as explained in the paper in three vectors:</span>
<span id="cb16-250"><a href="#cb16-250"></a></span>
<span id="cb16-251"><a href="#cb16-251"></a><span class="ss"> - </span>$D_t$ (as <span class="in">`d_t_0`</span>) based on the weekday means (DOWEs) that are passed as a vector to <span class="in">`dowe`</span> (default: all zeros);</span>
<span id="cb16-252"><a href="#cb16-252"></a> </span>
<span id="cb16-253"><a href="#cb16-253"></a><span class="ss"> - </span>$W_t$ (as <span class="in">`w_t_0`</span>) with workdays mean of 0, and weekend effect determined by the argument <span class="in">`wee`</span>; and </span>
<span id="cb16-254"><a href="#cb16-254"></a> </span>
<span id="cb16-255"><a href="#cb16-255"></a><span class="ss"> - </span>$H_t$ (as <span class="in">`h_t_0`</span>) with overall mean of 0 and given amplitude <span class="in">`amp`</span> (default: 0), and peak shift <span class="in">`peak_shift`</span> (default: 1, for Monday).</span>
<span id="cb16-256"><a href="#cb16-256"></a></span>
<span id="cb16-257"><a href="#cb16-257"></a>The time-varying mean <span class="in">`mu_t`</span> is constructed by adding <span class="in">`c`</span> to <span class="in">`d_t_0`</span>, <span class="in">`w_t_0`</span>, <span class="in">`h_t_0`</span>.</span>
<span id="cb16-258"><a href="#cb16-258"></a>This approach allows users to investigate the effect imposing multiple mechanisms for the mean structure $\mu_t$.</span>
<span id="cb16-259"><a href="#cb16-259"></a>Needless to say, $D_t$, in general, can account for any arbitrary shape in the mean structure;</span>
<span id="cb16-260"><a href="#cb16-260"></a>yet, our implementation may come in handy in the Shiny app (see @sec-sim-shiny).</span>
<span id="cb16-261"><a href="#cb16-261"></a></span>
<span id="cb16-262"><a href="#cb16-262"></a>The stochastic component $a_t$ is generated using <span class="in">`sarima::sim_sarima()`</span>.</span>
<span id="cb16-263"><a href="#cb16-263"></a>Since this function cannot generate white noise process, if no SAR<span class="co">[</span><span class="ot">I</span><span class="co">]</span>MA component is specified, <span class="in">`a_t`</span> is generated manually.</span>
<span id="cb16-264"><a href="#cb16-264"></a>In our simulation function <span class="in">`m_sim()`</span> we allow including non-seasonal and seasonal differencing in the model (which we did not discuss in the paper, but implemented in the Shiny app).</span>
<span id="cb16-265"><a href="#cb16-265"></a></span>
<span id="cb16-268"><a href="#cb16-268"></a><span class="in">```{r}</span></span>
<span id="cb16-269"><a href="#cb16-269"></a><span class="co">#| eval: true</span></span>
<span id="cb16-270"><a href="#cb16-270"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-271"><a href="#cb16-271"></a><span class="co">#| code-summary: "Click to reveal `m_sim()`"</span></span>
<span id="cb16-272"><a href="#cb16-272"></a></span>
<span id="cb16-273"><a href="#cb16-273"></a><span class="sc">&lt;</span><span class="er">&lt;</span>m_sim<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-274"><a href="#cb16-274"></a><span class="in">```</span></span>
<span id="cb16-275"><a href="#cb16-275"></a></span>
<span id="cb16-276"><a href="#cb16-276"></a><span class="fu">## Shiny app {#sec-sim-shiny}</span></span>
<span id="cb16-277"><a href="#cb16-277"></a></span>
<span id="cb16-278"><a href="#cb16-278"></a>To be completed later.</span>
<span id="cb16-279"><a href="#cb16-279"></a></span>
<span id="cb16-280"><a href="#cb16-280"></a><span class="fu"># Modeling time series data {#sec-modeling}</span></span>
<span id="cb16-281"><a href="#cb16-281"></a></span>
<span id="cb16-282"><a href="#cb16-282"></a>There are to functions that are used for analyzing the data:</span>
<span id="cb16-283"><a href="#cb16-283"></a><span class="in">`m_fit()`</span> does the model fitting, and <span class="in">`m_estimates()`</span> extracts the parameter estimates and post-processes them to get CIs and information criteria, and, if necessary, performs bootstrapping.</span>
<span id="cb16-284"><a href="#cb16-284"></a></span>
<span id="cb16-285"><a href="#cb16-285"></a><span class="fu">## Fitting time series models {#sec-fitting}</span></span>
<span id="cb16-286"><a href="#cb16-286"></a></span>
<span id="cb16-287"><a href="#cb16-287"></a>To carry out the analyses in the paper, we wrote a wrapper function called <span class="in">`m_fit()`</span> around <span class="in">`forecast::Arima()`</span> with additional capabilities which is a generalization of the code snippets shown in the paper.</span>
<span id="cb16-288"><a href="#cb16-288"></a></span>
<span id="cb16-289"><a href="#cb16-289"></a>This function flexibly determines the model orders by parsing the model name (as they were presented in the paper) passed as a string to <span class="in">`model_string`</span>, which helps using it in elsewhere, e.g., in a Shiny app.</span>
<span id="cb16-290"><a href="#cb16-290"></a></span>
<span id="cb16-293"><a href="#cb16-293"></a><span class="in">```{r}</span></span>
<span id="cb16-294"><a href="#cb16-294"></a><span class="co">#| eval: true</span></span>
<span id="cb16-295"><a href="#cb16-295"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-296"><a href="#cb16-296"></a><span class="co">#| code-summary: "Click to reveal `m_fit()`"</span></span>
<span id="cb16-297"><a href="#cb16-297"></a></span>
<span id="cb16-298"><a href="#cb16-298"></a><span class="sc">&lt;</span><span class="er">&lt;</span>m_fit<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-299"><a href="#cb16-299"></a><span class="in">```</span></span>
<span id="cb16-300"><a href="#cb16-300"></a></span>
<span id="cb16-301"><a href="#cb16-301"></a>This function can also save the fit object in a folder (specified by <span class="in">`save_folder_fit`</span>).</span>
<span id="cb16-302"><a href="#cb16-302"></a>To streamline the model fitting and post-processing the fit files, <span class="in">`m_fit()`</span> will call <span class="in">`m_estimates()`</span> if <span class="in">`save_est`</span> is set to <span class="in">`TRUE`</span>.</span>
<span id="cb16-303"><a href="#cb16-303"></a></span>
<span id="cb16-304"><a href="#cb16-304"></a><span class="fu">## Extracting parameter estimates {#sec-estimates}</span></span>
<span id="cb16-305"><a href="#cb16-305"></a></span>
<span id="cb16-306"><a href="#cb16-306"></a>The output of <span class="in">`m_fit()`</span> is a list of class <span class="in">`Arima`</span> that contains multiple components (see <span class="in">`?stats::arima`</span> and <span class="in">`?forecast::Arima`</span>), but does not contain the estimation standard errors and significances.</span>
<span id="cb16-307"><a href="#cb16-307"></a>Furthermore, in case $H_t$ is included in the model, the output does not contain estimates for peak shift $\psi$ and amplitude $S$.</span>
<span id="cb16-308"><a href="#cb16-308"></a></span>
<span id="cb16-309"><a href="#cb16-309"></a>The function <span class="in">`m_estimates()`</span> extracts the point estimates of the parameters( <span class="in">`m$coef`</span>) and calculates their estimation standard errors using the estimated variance matrix of the coefficients (<span class="in">`m$var.coef`</span>), and calculates 2.5% and 97.5% confidence intervals and significance of the estimates, and stores them in a dataframe called <span class="in">`estimates`</span>.</span>
<span id="cb16-310"><a href="#cb16-310"></a>The function returns a list that contains this dataframe as well as a 1-row dataframe <span class="in">`information_criteria`</span> that includes different information criteria (AIC, AICc, BIC) as well as the absolute value of the log-likelihood (that could have been used as a criterion in model selection, which we did not use in our paper).</span>
<span id="cb16-311"><a href="#cb16-311"></a></span>
<span id="cb16-312"><a href="#cb16-312"></a>In case the harmonic mean structure is in the model, this function also calculates points estimates and their CIs of peak shift $\psi$ and amplitude $S$ by means of bootstrapping by drawing <span class="in">`boot_n`</span> samples (default: 10000) from the multivariate normal distribution attributable implied by the estimated variance matrix of the coefficients.</span>
<span id="cb16-313"><a href="#cb16-313"></a></span>
<span id="cb16-316"><a href="#cb16-316"></a><span class="in">```{r}</span></span>
<span id="cb16-317"><a href="#cb16-317"></a><span class="co">#| eval: true</span></span>
<span id="cb16-318"><a href="#cb16-318"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-319"><a href="#cb16-319"></a><span class="co">#| code-summary: "Click to reveal `m_estimates()`"</span></span>
<span id="cb16-320"><a href="#cb16-320"></a></span>
<span id="cb16-321"><a href="#cb16-321"></a><span class="sc">&lt;</span><span class="er">&lt;</span>m_estimates<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-322"><a href="#cb16-322"></a><span class="in">```</span></span>
<span id="cb16-323"><a href="#cb16-323"></a></span>
<span id="cb16-324"><a href="#cb16-324"></a>The amplitude $S$ and peak shift $\psi$ are respectively calculated by two auxiliary functions, <span class="in">`calc_amp()`</span> and <span class="in">`calc_peak_theta()`</span>, which are vectorized (using <span class="in">`Vectorize()`</span>) to increase the performance when applied to bootstrapped values.</span>
<span id="cb16-325"><a href="#cb16-325"></a>Note that <span class="in">`calc_peak_theta(a, b)`</span> is equivalent to <span class="in">`base::atan2(b, a)`</span>, which is the <span class="co">[</span><span class="ot">2-argument arctangent function</span><span class="co">](https://en.wikipedia.org/wiki/Atan2)</span>;</span>
<span id="cb16-326"><a href="#cb16-326"></a>we explicitly defined this function in our code to mirror the expression provided in Equation 22b of the paper.</span>
<span id="cb16-327"><a href="#cb16-327"></a></span>
<span id="cb16-330"><a href="#cb16-330"></a><span class="in">```{r}</span></span>
<span id="cb16-331"><a href="#cb16-331"></a><span class="co">#| eval: true</span></span>
<span id="cb16-332"><a href="#cb16-332"></a><span class="co">#| code-fold: true</span></span>
<span id="cb16-333"><a href="#cb16-333"></a><span class="co">#| code-summary: "Click to reveal `calc_amp()` and `calc_peak_theta()`"</span></span>
<span id="cb16-334"><a href="#cb16-334"></a></span>
<span id="cb16-335"><a href="#cb16-335"></a><span class="sc">&lt;</span><span class="er">&lt;</span>aux_functions<span class="sc">&gt;</span><span class="er">&gt;</span></span>
<span id="cb16-336"><a href="#cb16-336"></a><span class="in">```</span></span>
<span id="cb16-337"><a href="#cb16-337"></a></span>
<span id="cb16-338"><a href="#cb16-338"></a>Note that the variable $\psi$ is circular with a period of 7, that is, peak shifts of $\psi$ and $\psi + 7$ and $\psi - 7$ are equivalent, thus its value cannot calculate summary statistics such as mean, median, and quantiles based on its $0 - 7$ values;</span>
<span id="cb16-339"><a href="#cb16-339"></a>for instance, an individual with $\psi_1 = 1$ (peaking on Monday) is more similar to someone with $\psi_2 = 6$ (peaking on Saturday) than someone with and $\psi_3 = 4$ (peaking on Thursday).</span>
<span id="cb16-340"><a href="#cb16-340"></a>To take the cisrularity of this variable into account, we use <span class="in">`circular`</span> package <span class="co">[</span><span class="ot">@lund_2023_CircularCircularStatistics</span><span class="co">]</span> that helps us in calculating </span>
<span id="cb16-341"><a href="#cb16-341"></a></span>
<span id="cb16-342"><a href="#cb16-342"></a>This should be noted when calculating the point estimate (either by mean or median) and CIs of the bootstrapped values.</span>
<span id="cb16-343"><a href="#cb16-343"></a></span>
<span id="cb16-344"><a href="#cb16-344"></a></span>
<span id="cb16-345"><a href="#cb16-345"></a></span>
<span id="cb16-346"><a href="#cb16-346"></a><span class="fu"># Analyzing empirical data {#sec-analysis}</span></span>
<span id="cb16-347"><a href="#cb16-347"></a></span>
<span id="cb16-348"><a href="#cb16-348"></a><span class="fu">## Fitting models to the whole dataset {#sec-empirical-fitting}</span></span>
<span id="cb16-349"><a href="#cb16-349"></a></span>
<span id="cb16-352"><a href="#cb16-352"></a><span class="in">```{r}</span></span>
<span id="cb16-353"><a href="#cb16-353"></a><span class="co">#| eval: false</span></span>
<span id="cb16-354"><a href="#cb16-354"></a></span>
<span id="cb16-355"><a href="#cb16-355"></a>d_w <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data_private/d_w"</span>)</span>
<span id="cb16-356"><a href="#cb16-356"></a>d_pa <span class="ot">&lt;-</span> d_w <span class="sc">%&gt;%</span></span>
<span id="cb16-357"><a href="#cb16-357"></a>  <span class="fu">filter</span>(item <span class="sc">==</span> <span class="st">"avg.pa"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-358"><a href="#cb16-358"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-359"><a href="#cb16-359"></a>    <span class="at">weekday =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb16-360"><a href="#cb16-360"></a>                              <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb16-361"><a href="#cb16-361"></a>                              <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb16-362"><a href="#cb16-362"></a>    <span class="at">weekday_num =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date,</span>
<span id="cb16-363"><a href="#cb16-363"></a>                                  <span class="at">week_start =</span> <span class="dv">1</span>,</span>
<span id="cb16-364"><a href="#cb16-364"></a>                                  <span class="at">label =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-365"><a href="#cb16-365"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-366"><a href="#cb16-366"></a>  <span class="fu">select</span>(id, t, y, date, weekday, weekday_num)</span>
<span id="cb16-367"><a href="#cb16-367"></a><span class="in">```</span></span>
<span id="cb16-368"><a href="#cb16-368"></a></span>
<span id="cb16-369"><a href="#cb16-369"></a><span class="fu">## Results {#sec-empirical-results}</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>